<html>

<head>
  <script type="module">
    import { store as rightDrawerStore } from "/components/sidebar/right-drawer-store.js";
  </script>
</head>

<body>
  <div x-data
       x-effect="document.body.classList.toggle('right-drawer-open', !!($store.rightDrawer && $store.rightDrawer.isOpen))">

    <template x-if="$store.rightDrawer">
      <div class="right-drawer-wrapper">

        <!-- Mobile overlay: tap outside to close -->
        <div class="right-drawer-overlay"
             :class="{'visible': $store.rightDrawer.isOpen && $store.rightDrawer.apps.length > 0}"
             @click="$store.rightDrawer.toggleDrawer()">
        </div>

        <!-- Drawer Panel -->
        <div id="right-drawer-panel"
             :class="{'drawer-hidden': !$store.rightDrawer.isOpen || $store.rightDrawer.apps.length === 0}">

          <!-- Tab bar -->
          <div class="rd-tabbar" x-show="$store.rightDrawer.apps.length > 0">
            <template x-for="tab in $store.rightDrawer.apps" :key="tab.name">
              <button class="rd-tab"
                      :class="{ 'rd-tab--active': $store.rightDrawer.active === tab.name }"
                      :style="`--tab-color: ${tab.color}`"
                      @click="$store.rightDrawer.setActive(tab.name)">
                <span class="rd-tab-dot" :style="`background: ${tab.color}`"></span>
                <span class="rd-tab-name" x-text="tab.name.replace(/-/g, '\u00a0')"></span>
                <span class="rd-tab-newtab material-symbols-outlined"
                      @click.stop="window.open(`/${tab.name}/`, '_blank')"
                      title="Open in new tab">open_in_new</span>
                <span class="rd-tab-close material-symbols-outlined"
                      @click.stop="$store.rightDrawer.closeTab(tab.name)"
                      title="Close tab">close</span>
              </button>
            </template>
          </div>

          <!-- Iframe stack: one per tab, CSS-hidden when inactive (no reload) -->
          <div class="rd-frames">
            <template x-for="tab in $store.rightDrawer.apps" :key="tab.name">
              <div class="rd-frame"
                   :class="{ 'rd-frame--active': $store.rightDrawer.active === tab.name }">
                <iframe :src="`/${tab.name}/`"
                        class="rd-iframe"
                        frameborder="0"
                        allow="microphone; camera; clipboard-read; clipboard-write">
                </iframe>
              </div>
            </template>
          </div>

        </div>
      </div>
    </template>
  </div>

  <style>
    /* ── Wrapper ── */
    .right-drawer-wrapper {
      position: relative;
    }

    /* ── Panel ── */
    #right-drawer-panel {
      background-color: var(--color-panel);
      border-left: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      transition: margin-right var(--transition-speed) ease-in-out;
      width: 420px;
      min-width: 420px;
      height: 100vh;
      overflow: hidden;
      box-shadow: -2px 0 15px rgba(0, 242, 254, 0.05);
    }

    #right-drawer-panel.drawer-hidden {
      margin-right: -420px;
    }

    .light-mode #right-drawer-panel {
      box-shadow: -1px 0 10px rgba(0, 0, 0, 0.1);
    }

    /* ── Tab bar ── */
    .rd-tabbar {
      display: flex;
      overflow-x: auto;
      overflow-y: hidden;
      flex-shrink: 0;
      border-bottom: 1px solid var(--color-border);
      background-color: var(--color-panel);
      scrollbar-width: none;
    }

    .rd-tabbar::-webkit-scrollbar { display: none; }

    /* ── Individual tab ── */
    .rd-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 var(--spacing-sm);
      height: 2.5rem;
      min-width: 0;
      max-width: 160px;
      flex-shrink: 0;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--color-text);
      font-family: var(--font-family-main);
      font-size: var(--font-size-small);
      cursor: pointer;
      opacity: 0.55;
      transition: opacity 0.15s ease, border-color 0.15s ease, background 0.15s ease;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }

    .rd-tab:hover {
      opacity: 0.85;
      background: color-mix(in srgb, var(--tab-color, transparent) 8%, transparent);
    }

    .rd-tab--active {
      opacity: 1;
      border-bottom-color: var(--tab-color, var(--color-primary));
      background: color-mix(in srgb, var(--tab-color, transparent) 12%, transparent);
    }

    /* ── Tab dot (color indicator) ── */
    .rd-tab-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ── Tab name ── */
    .rd-tab-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: left;
      text-transform: capitalize;
    }

    /* ── Tab actions (open-in-new + close) ── */
    .rd-tab-newtab,
    .rd-tab-close {
      font-size: 14px !important;
      line-height: 1;
      opacity: 0;
      flex-shrink: 0;
      border-radius: 3px;
      padding: 1px;
      transition: opacity 0.15s ease, background 0.15s ease;
    }

    .rd-tab:hover .rd-tab-newtab,
    .rd-tab:hover .rd-tab-close,
    .rd-tab--active .rd-tab-newtab,
    .rd-tab--active .rd-tab-close {
      opacity: 0.55;
    }

    .rd-tab-newtab:hover,
    .rd-tab-close:hover {
      opacity: 1 !important;
      background: color-mix(in srgb, var(--tab-color, var(--color-border)) 30%, transparent);
    }

    /* ── Frame container ── */
    .rd-frames {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    /* ── Individual frame (one per tab) ── */
    .rd-frame {
      position: absolute;
      inset: 0;
      visibility: hidden;
      pointer-events: none;
      display: flex;
    }

    .rd-frame--active {
      visibility: visible;
      pointer-events: auto;
    }

    /* ── Iframe ── */
    .rd-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: var(--color-background);
    }

    /* ── Toggle button inside #time-date-container ── */
    .rd-topbar-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 2rem;
      width: 2rem;
      background: transparent;
      border: 0.05rem solid var(--color-border);
      border-radius: 6px;
      color: var(--color-primary);
      cursor: pointer;
      opacity: 0.75;
      padding: 0;
      flex-shrink: 0;
      margin-left: var(--spacing-xs);
      transition: all var(--transition-speed) ease;
    }

    .rd-topbar-toggle:hover {
      opacity: 1;
      background: var(--color-background-hover);
    }

    .rd-topbar-toggle:active {
      opacity: 0.5;
      transform: scale(0.92);
    }

    .rd-topbar-toggle .material-symbols-outlined {
      font-size: 18px;
    }

    /* ── Shift the time/date widget left when drawer is open ── */
    #time-date-container {
      transition: right var(--transition-speed) ease-in-out;
    }

    .right-drawer-open #time-date-container {
      right: calc(420px + var(--spacing-sm));
    }

    /* ── Mobile overlay ── */
    .right-drawer-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1002;
    }

    @media (max-width: 768px) {
      #right-drawer-panel {
        position: fixed;
        right: 0;
        top: 0;
        bottom: 0;
        width: min(420px, 100vw) !important;
        min-width: unset;
        z-index: 1003;
      }

      #right-drawer-panel.drawer-hidden {
        margin-right: calc(-1 * min(420px, 100vw));
      }

      .right-drawer-overlay.visible {
        display: block;
      }
    }
  </style>
</body>

</html>
