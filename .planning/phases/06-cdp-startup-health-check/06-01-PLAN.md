---
phase: 06-cdp-startup-health-check
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/shared-browser/startup.sh
autonomous: true
requirements:
  - BROWSER-04

must_haves:
  truths:
    - "Shared browser startup confirms CDP is ready via HTTP poll before Flask starts — sleep 2 is gone"
    - "A failed or slow Chromium startup emits a diagnostic message to stderr and exits 1 — no silent hang"
    - "CDP WebSocket connection attempt from Agent Zero succeeds immediately after shared-browser app reports ready"
  artifacts:
    - path: "apps/shared-browser/startup.sh"
      provides: "Deterministic CDP readiness poll replacing sleep 2"
      contains: "until curl -sf http://localhost:9222/json"
  key_links:
    - from: "apps/shared-browser/startup.sh"
      to: "http://localhost:9222/json"
      via: "curl -sf in until loop"
      pattern: "until curl -sf http://localhost:9222/json"
    - from: "CHROMIUM_PID assignment"
      to: "kill -0 $CHROMIUM_PID"
      via: "process liveness check inside poll loop"
      pattern: "kill -0.*CHROMIUM_PID"
---

<objective>
Replace the fragile `sleep 2` guard in `apps/shared-browser/startup.sh` with a deterministic bash polling loop that confirms Chromium's CDP HTTP endpoint is responding before Flask starts.

Purpose: Eliminates the race condition where Agent Zero attempts a CDP connection immediately after the app reports ready, only to receive "connection refused" because Chromium hasn't finished binding port 9222.

Output: Updated `startup.sh` — single file, pure bash, no new dependencies.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cdp-startup-health-check/06-RESEARCH.md
@apps/shared-browser/startup.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace sleep 2 with CDP readiness poll in startup.sh</name>
  <files>apps/shared-browser/startup.sh</files>
  <action>
Replace line 42 (`sleep 2`) in `apps/shared-browser/startup.sh` with the following polling block. Insert it between the `CHROMIUM_PID=$!` assignment and the `echo "All services started"` line:

```bash
# Wait for Chromium CDP to be ready (replaces sleep 2)
echo "Waiting for Chromium CDP on :9222..."
MAX_ATTEMPTS=20
ATTEMPT=0
until curl -sf http://localhost:9222/json > /dev/null 2>&1; do
    ATTEMPT=$((ATTEMPT + 1))
    if [ "$ATTEMPT" -ge "$MAX_ATTEMPTS" ]; then
        echo "ERROR: Chromium CDP on :9222 not ready after ${MAX_ATTEMPTS} attempts (10s timeout)." >&2
        echo "  Chromium PID: $CHROMIUM_PID  alive: $(kill -0 $CHROMIUM_PID 2>/dev/null && echo yes || echo NO)" >&2
        exit 1
    fi
    if ! kill -0 "$CHROMIUM_PID" 2>/dev/null; then
        echo "ERROR: Chromium (PID $CHROMIUM_PID) exited during startup." >&2
        exit 1
    fi
    sleep 0.5
done
echo "Chromium CDP ready (attempt $((ATTEMPT + 1)), ~$((ATTEMPT * 500))ms)"
```

Key implementation notes:
- `curl -sf`: `-s` suppresses progress output, `-f` makes curl exit non-zero on HTTP errors. Output is discarded; only exit code matters.
- The `until` loop condition is a conditional context — `set -e` at line 4 does NOT abort on curl's non-zero exit inside `until`. This is correct bash behavior.
- `kill -0 $CHROMIUM_PID`: Checks process liveness without sending a signal. If Chromium crashes during the poll, we detect it and exit with a diagnostic rather than waiting out the full 10s timeout.
- 20 attempts × 0.5s = 10 second maximum wait. Chromium typically starts in 1-3 seconds in Docker.
- The `sleep 1` at line 20 (process cleanup guard) is a different concern — leave it untouched.
- Do NOT add `set +e` around the loop — the `until` conditional context already handles this correctly.

After the edit, the sequence in startup.sh must be:
1. `pkill`/`fuser` cleanup block + `sleep 1` (lines 12-20, unchanged)
2. Chromium launch block ending with `CHROMIUM_PID=$!` (lines 22-41, unchanged)
3. NEW: CDP readiness polling block (replaces the single `sleep 2` at line 42)
4. `echo "All services started"` + Flask `exec` block (lines 44-51, unchanged)
  </action>
  <verify>
Run these checks after editing:

1. Confirm `sleep 2` is gone:
   ```bash
   grep -n "sleep 2" /Users/rgv250cc/Documents/Projects/agent-zero/apps/shared-browser/startup.sh
   ```
   Expected: no output (empty).

2. Confirm poll loop is present:
   ```bash
   grep -n "until curl -sf" /Users/rgv250cc/Documents/Projects/agent-zero/apps/shared-browser/startup.sh
   ```
   Expected: one match showing the `until curl -sf http://localhost:9222/json` line.

3. Confirm process liveness check is present:
   ```bash
   grep -n "kill -0" /Users/rgv250cc/Documents/Projects/agent-zero/apps/shared-browser/startup.sh
   ```
   Expected: two matches (one in the ATTEMPT timeout block, one in the process death check).

4. Confirm `set -e` is still at line 4 and untouched:
   ```bash
   grep -n "set -e" /Users/rgv250cc/Documents/Projects/agent-zero/apps/shared-browser/startup.sh
   ```
   Expected: one match at line 4.

5. Confirm bash syntax is valid:
   ```bash
   bash -n /Users/rgv250cc/Documents/Projects/agent-zero/apps/shared-browser/startup.sh
   ```
   Expected: exits 0 with no output.

6. Confirm exec Flask line is still the last line:
   ```bash
   tail -3 /Users/rgv250cc/Documents/Projects/agent-zero/apps/shared-browser/startup.sh
   ```
   Expected: shows `cd "$APP_DIR"` and `exec /opt/venv-a0/bin/python app.py`.
  </verify>
  <done>
`startup.sh` passes `bash -n` syntax check. `sleep 2` is absent. `until curl -sf http://localhost:9222/json` loop is present with MAX_ATTEMPTS=20 and 0.5s sleep interval. Both `kill -0 $CHROMIUM_PID` guards are present (timeout guard and crash-early guard). `exec /opt/venv-a0/bin/python app.py` remains the final line.
  </done>
</task>

</tasks>

<verification>
After task completion, verify the complete state:

1. `bash -n apps/shared-browser/startup.sh` exits 0 — no syntax errors.
2. `grep "sleep 2" apps/shared-browser/startup.sh` returns empty — fragile guard is gone.
3. `grep "until curl -sf" apps/shared-browser/startup.sh` returns one match — poll loop present.
4. `grep "kill -0" apps/shared-browser/startup.sh` returns two matches — process liveness guards present.
5. `grep "ERROR:" apps/shared-browser/startup.sh` returns two matches — diagnostic messages present for both failure modes (timeout and crash).
6. File structure is correct: cleanup → Chromium launch → CDP poll → Flask exec.
</verification>

<success_criteria>
Phase 6 is complete when:
- `sleep 2` is gone from `apps/shared-browser/startup.sh`
- CDP readiness is confirmed via `curl -sf http://localhost:9222/json` poll (20 × 0.5s = 10s max)
- Chromium process liveness is checked on each iteration — crash detected immediately
- Timeout failure emits a diagnostic to stderr and exits 1 — no silent hang
- `bash -n` confirms no syntax errors introduced
- `set -e` at line 4 is preserved and the `until` loop works correctly with it
</success_criteria>

<output>
After completion, create `.planning/phases/06-cdp-startup-health-check/06-01-SUMMARY.md` capturing:
- What changed in startup.sh (exact lines replaced)
- The poll pattern used (curl -sf, MAX_ATTEMPTS, interval)
- Verification results (bash -n, grep checks)
- Any deviations from the plan
</output>
