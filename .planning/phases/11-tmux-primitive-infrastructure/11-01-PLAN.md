---
phase: 11-tmux-primitive-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - python/tools/tmux_tool.py
  - prompts/agent.system.tool.tmux.md
autonomous: true
requirements:
  - TERM-01
  - TERM-02
  - TERM-03
  - TERM-04

must_haves:
  truths:
    - "Agent Zero sends a command + Enter to the shared tmux pane and it executes visibly in the user's terminal"
    - "Agent Zero sends text without Enter (e.g. 'y') to respond to an inline y/N prompt"
    - "Agent Zero sends Ctrl+C to interrupt a running process; Tab for completion; arrow keys for navigation"
    - "Agent Zero captures current pane screen content and receives clean plain text with no ANSI escape sequences"
    - "No sentinel marker text (echo MARKER:$? or similar) is ever written into the shared session by tmux_tool"
    - "terminal_agent.py is not modified — both tools coexist unchanged"
  artifacts:
    - path: "python/tools/tmux_tool.py"
      provides: "TmuxTool class with send/keys/read action dispatch"
      contains: "class TmuxTool(Tool)"
      min_lines: 60
    - path: "prompts/agent.system.tool.tmux.md"
      provides: "Agent-facing tool documentation auto-loaded by agent.system.tools.py glob"
      contains: "tmux_tool"
      min_lines: 30
  key_links:
    - from: "python/tools/tmux_tool.py"
      to: "tmux send-keys"
      via: "subprocess.run list-form (no shell=True)"
      pattern: "subprocess\\.run.*tmux.*send-keys"
    - from: "python/tools/tmux_tool.py"
      to: "tmux capture-pane"
      via: "subprocess.run without -e flag"
      pattern: "capture-pane.*-p.*-S"
    - from: "python/tools/tmux_tool.py"
      to: "ANSI_RE.sub"
      via: "applied to capture-pane stdout before returning"
      pattern: "ANSI_RE\\.sub.*result\\.stdout"
    - from: "prompts/agent.system.tool.tmux.md"
      to: "agent.system.tools.py glob"
      via: "filename matches agent.system.tool.*.md pattern"
      pattern: "agent\\.system\\.tool\\.tmux\\.md"
---

<objective>
Create the tmux primitive infrastructure: a new `TmuxTool` Python class providing `send`, `keys`, and `read` actions against the shared tmux session, plus its agent-facing prompt documentation.

Purpose: Every v1.2 phase (12–15) depends on these three primitives — they are the foundation for all interactive CLI orchestration. Without these actions, Agent Zero cannot type, send special keys, or observe the shared terminal.

Output:
- `python/tools/tmux_tool.py` — TmuxTool class (sentinel-free, subprocess.run, ANSI stripping)
- `prompts/agent.system.tool.tmux.md` — auto-registered prompt documentation
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-tmux-primitive-infrastructure/11-RESEARCH.md

# Reference: existing tool for pattern matching
@python/tools/terminal_agent.py
@python/helpers/tool.py
@prompts/agent.system.tool.terminal.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create python/tools/tmux_tool.py with send/keys/read actions</name>
  <files>python/tools/tmux_tool.py</files>
  <action>
Create `python/tools/tmux_tool.py` implementing `TmuxTool(Tool)` with three actions dispatched via `self.args.get("action")`:

**Module-level constants (before the class):**
```python
import subprocess
import re
from python.helpers.tool import Tool, Response

_TMUX_SESSION = "shared"

# Pre-established project ANSI strip regex (STATE.md, claude_cli.py)
# Covers: 2-char ESC sequences, CSI color/cursor, OSC title sequences
ANSI_RE = re.compile(r'\x1b(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~]|\][^\x07]*\x07)')
```

**Class docstring** must state: "Coexists with terminal_agent.py (sentinel pattern). This tool is sentinel-free."

**`execute()` dispatch:**
```python
async def execute(self, **kwargs):
    action = self.args.get("action", "").strip().lower()
    dispatch = {"send": self._send, "keys": self._keys, "read": self._read}
    handler = dispatch.get(action)
    if not handler:
        return Response(
            message=f"Unknown action '{action}'. Valid actions: send, keys, read.",
            break_loop=False,
        )
    return await handler()
```

**`_send()` action (TERM-01 — text + Enter):**
- Get `text` from `self.args` (strip whitespace). Return error if empty.
- Get `pane` from `self.args`, default `_TMUX_SESSION`.
- Call: `subprocess.run(["tmux", "send-keys", "-t", pane, text, "Enter"], capture_output=True, text=True)`
  - `text` is passed as ONE list element (not split) — prevents tmux from interpreting words like "Tab" as key names.
  - `"Enter"` is the SEPARATE final argument — this is the key press.
- On `returncode != 0`: return Response with `result.stderr.strip()` + "Is shared-terminal running?"
- On success: return Response `f"Sent: {text!r} + Enter"`

**`_keys()` action (TERM-02 + TERM-03 — key sequences without Enter):**
- Get `keys` from `self.args`. Accept both `list` and `str`:
  - If `list`: use directly as `key_args`
  - If `str`: split on whitespace → `key_args`
  - If empty after normalization: return error.
- Get `pane` from `self.args`, default `_TMUX_SESSION`.
- Call: `subprocess.run(["tmux", "send-keys", "-t", pane] + key_args, capture_output=True, text=True)`
  - Each element of `key_args` IS a tmux key name — intentional (unlike `_send` where text is literal).
- On `returncode != 0`: return Response with stderr.
- On success: return Response `f"Keys sent: {key_args}"`

**`_read()` action (TERM-04 — capture pane content):**
- Get `pane` from `self.args`, default `_TMUX_SESSION`.
- Get `lines` from `self.args`, default `100`, cast to `int`.
- Call: `subprocess.run(["tmux", "capture-pane", "-t", pane, "-p", "-S", f"-{lines}"], capture_output=True, text=True)`
  - CRITICAL: NO `-e` flag — omitting it prevents tmux from including raw escape sequences in output.
- On `returncode != 0`: return Response with stderr + "Is shared-terminal running?"
- Apply ANSI strip: `clean = ANSI_RE.sub('', result.stdout).rstrip()`
- Return `Response(message=clean or "(pane is empty)", break_loop=False)`

**Constraints (from REQUIREMENTS.md and STATE.md):**
- No sentinel injection anywhere in this file — no `echo MARKER` pattern
- No `subprocess.run(..., shell=True)` — always use list form
- No `asyncio.create_subprocess_exec` — synchronous subprocess.run is correct for <50ms tmux calls
- Do NOT import or touch `terminal_agent.py`
- Do NOT add `libtmux` or `pexpect` to requirements.txt
  </action>
  <verify>
Run from the project root:
```bash
python -c "
import ast, sys
with open('python/tools/tmux_tool.py') as f:
    src = f.read()

# Structural checks
tree = ast.parse(src)
classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
assert 'TmuxTool' in classes, 'TmuxTool class missing'

# Key content checks
assert 'ANSI_RE' in src, 'ANSI_RE missing'
assert 'capture-pane' in src, 'capture-pane missing'
assert 'send-keys' in src, 'send-keys missing'
assert 'MARKER' not in src, 'Sentinel injection found — VIOLATION'
assert 'shell=True' not in src, 'shell=True found — VIOLATION'
assert '-e' not in src or 'capture-pane' not in src.split('-e')[0], 'Possible -e flag with capture-pane'
assert 'libtmux' not in src, 'libtmux found — VIOLATION'
assert 'pexpect' not in src, 'pexpect found — VIOLATION'

print('All checks passed')
"
```

Also verify the file exists and has reasonable size:
```bash
wc -l python/tools/tmux_tool.py
```
Expected: 60+ lines.
  </verify>
  <done>
`python/tools/tmux_tool.py` exists with TmuxTool class implementing send/keys/read actions. All structural checks pass: ANSI_RE present, capture-pane used without -e, no sentinel injection, no shell=True, no libtmux/pexpect. File is 60+ lines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create prompts/agent.system.tool.tmux.md for auto-registration</name>
  <files>prompts/agent.system.tool.tmux.md</files>
  <action>
Create `prompts/agent.system.tool.tmux.md`. This file is auto-loaded by `agent.system.tools.py` which globs `agent.system.tool.*.md` — no other registration needed.

Model the format after `prompts/agent.system.tool.terminal.md` (which uses `### tool_name:` heading, `!!! ` warning lines, `#### Arguments:` section, and `#### Usage:` examples with JSON code blocks).

**Required content structure:**

```markdown
### tmux_tool:

Interact directly with the shared tmux terminal session (the same terminal visible to the user in the drawer).
Use this tool to orchestrate interactive CLI sessions — NOT for simple shell commands (use `terminal_agent` for those).

**REQUIRED STEP BEFORE USE**: call `open_app` first:
`{ "action": "open", "app": "shared-terminal" }`

!!! The shared tmux session is named `shared` — all actions target it by default
!!! `send` types text + Enter; `keys` sends key sequences WITHOUT Enter; `read` captures what is on screen
!!! No sentinel markers are ever injected — screen capture is the only observation mechanism
!!! Both `terminal_agent` and `tmux_tool` share the same `shared` session — coordinate use

#### Arguments:
* `action` (string, required) — `send` | `keys` | `read`
* `text` (string) — for `send`: the text to type (Enter is added automatically)
* `keys` (string or list) — for `keys`: tmux key names space-separated, e.g. `"C-c"`, `"Tab"`, `"Escape"`, `"Up"`
* `pane` (string, optional) — tmux pane target (default: `"shared"`)
* `lines` (number, optional) — for `read`: scrollback lines to capture (default: 100)

#### Special key names:
`C-c` (Ctrl+C), `C-d` (Ctrl+D), `Tab`, `BTab` (Shift+Tab), `Escape`, `Enter`,
`Up`, `Down`, `Left`, `Right`, `BSpace`, `PPage` (Page Up), `NPage` (Page Down)
```

**Four usage examples** (JSON code blocks matching Agent Zero's tool call format from `agent.system.tool.code_exe.md`):

1. Run a command (send + Enter):
```json
{ "tool_name": "tmux_tool", "tool_args": { "action": "send", "text": "ls -la" } }
```

2. Answer inline y/N prompt (keys, no Enter):
```json
{ "tool_name": "tmux_tool", "tool_args": { "action": "keys", "keys": "y" } }
```

3. Interrupt a running process (Ctrl+C):
```json
{ "tool_name": "tmux_tool", "tool_args": { "action": "keys", "keys": "C-c" } }
```

4. Read current terminal screen:
```json
{ "tool_name": "tmux_tool", "tool_args": { "action": "read" } }
```

**Critical distinctions to include in documentation:**
- `send` vs `keys`: `send` is for typed text that needs Enter (running commands, submitting prompts). `keys` is for special keys and partial text that must NOT have Enter appended (Ctrl+C, Tab, y/N responses, arrow navigation).
- `tmux_tool` vs `terminal_agent`: Use `terminal_agent` for simple shell commands with known exit codes. Use `tmux_tool` for interactive CLIs where you need to observe prompts and respond.
  </action>
  <verify>
```bash
# File exists and auto-registration pattern works
ls -la prompts/agent.system.tool.tmux.md

# Check required sections present
python -c "
with open('prompts/agent.system.tool.tmux.md') as f:
    content = f.read()

assert '### tmux_tool:' in content, 'Tool heading missing'
assert 'action' in content, 'action argument missing'
assert 'send' in content, 'send action missing'
assert 'keys' in content, 'keys action missing'
assert 'read' in content, 'read action missing'
assert 'C-c' in content, 'C-c key name missing'
assert 'open_app' in content, 'open_app prerequisite missing'
assert 'terminal_agent' in content, 'terminal_agent distinction missing'
print('Prompt doc checks passed')
"

# Confirm glob pattern will pick it up (verify naming convention)
python -c "
import glob
matches = glob.glob('prompts/agent.system.tool.*.md')
assert any('tmux' in m for m in matches), 'tmux prompt not in glob results'
print('Glob auto-registration confirmed:', [m for m in matches if 'tmux' in m])
"
```
  </verify>
  <done>
`prompts/agent.system.tool.tmux.md` exists with ### tmux_tool: heading, all four usage examples, special key names reference, and clear send/keys/read distinction. The glob pattern `agent.system.tool.*.md` picks it up automatically — confirmed by Python glob check.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full phase verification:

```bash
# 1. Both files exist
ls -la python/tools/tmux_tool.py prompts/agent.system.tool.tmux.md

# 2. Tool class is syntactically valid Python
python -c "import ast; ast.parse(open('python/tools/tmux_tool.py').read()); print('Syntax OK')"

# 3. TmuxTool is importable (no import errors)
cd /Users/rgv250cc/Documents/Projects/agent-zero && python -c "
import sys
sys.path.insert(0, '.')
# Only check syntax-level imports — Agent/Tool need full runtime
import ast
src = open('python/tools/tmux_tool.py').read()
tree = ast.parse(src)
print('Parse OK')
classes = [n.name for n in ast.walk(tree) if isinstance(n, ast.ClassDef)]
print('Classes:', classes)
assert 'TmuxTool' in classes
"

# 4. ANSI regex is correct (matches the project-standard regex from STATE.md)
python -c "
import re
ANSI_RE = re.compile(r'\x1b(?:[@-Z\\\\-_]|\[[0-?]*[ -/]*[@-~]|\][^\x07]*\x07)')
# Test: OSC title sequence stripped
test = '\x1b]0;bash\x07prompt\$ '
clean = ANSI_RE.sub('', test)
assert 'prompt\$ ' in clean and '\x1b' not in clean, f'ANSI strip failed: {clean!r}'
print('ANSI regex OK')
"

# 5. terminal_agent.py unchanged
git diff python/tools/terminal_agent.py
# Expected: empty (no changes)

# 6. No new dependencies added to requirements.txt
grep -E 'libtmux|pexpect' requirements.txt && echo "VIOLATION" || echo "No forbidden deps"
```
</verification>

<success_criteria>
Phase 11 is complete when:
- `python/tools/tmux_tool.py` exists with TmuxTool class implementing send (TERM-01), keys (TERM-02, TERM-03), and read (TERM-04) actions
- ANSI_RE strip is applied to all capture-pane output before returning
- No sentinel injection anywhere in the file
- `prompts/agent.system.tool.tmux.md` exists and is picked up by the `agent.system.tool.*.md` glob
- `terminal_agent.py` is unchanged
- All Python checks pass (syntax, class name, no forbidden patterns)
</success_criteria>

<output>
After completion, create `.planning/phases/11-tmux-primitive-infrastructure/11-01-SUMMARY.md`
</output>
