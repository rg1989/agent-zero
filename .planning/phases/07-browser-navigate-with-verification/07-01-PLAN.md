---
phase: 07-browser-navigate-with-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - requirements.txt
  - usr/skills/shared-browser/SKILL.md
autonomous: true
requirements: [BROWSER-01, BROWSER-02, BROWSER-03, BROWSER-05]

must_haves:
  truths:
    - "Agent code can `import websocket` without ModuleNotFoundError — websocket-client is in requirements.txt"
    - "Agent navigates via `navigate_and_wait()` which polls `document.readyState == 'complete'` — bare `Page.navigate` + sleep is gone from SKILL.md"
    - "SKILL.md mandates a screenshot (Observe) before every browser action — enforcement language is explicit ('ALWAYS', 'REQUIRED')"
    - "After navigation, agent calls `verify_navigation()` to read current URL and page title via CDP Runtime.evaluate"
    - "SKILL.md has a named 'Observe-Act-Verify' section with numbered steps, not just 3 informal bullet points"
    - "The fragile `time.sleep(2)` in the 'Capture LIVE Network' section is replaced with `navigate_and_wait()`"
  artifacts:
    - path: "requirements.txt"
      provides: "websocket-client>=1.9.0 dependency"
      contains: "websocket-client>=1.9.0"
    - path: "usr/skills/shared-browser/SKILL.md"
      provides: "Full Observe-Act-Verify workflow with navigate_and_wait() and verify_navigation()"
      contains: "navigate_and_wait"
      min_lines: 200
  key_links:
    - from: "usr/skills/shared-browser/SKILL.md"
      to: "requirements.txt"
      via: "websocket-client import in code examples"
      pattern: "import websocket"
    - from: "navigate_and_wait()"
      to: "document.readyState"
      via: "Runtime.evaluate poll in SKILL.md"
      pattern: "document\\.readyState"
    - from: "verify_navigation()"
      to: "location.href, document.title"
      via: "Runtime.evaluate in SKILL.md"
      pattern: "location\\.href"
---

<objective>
Rewrite the shared-browser SKILL.md to document and enforce CDP navigate-with-verification and the Observe-Act-Verify workflow. Add websocket-client to requirements.txt so agent code examples are runnable.

Purpose: Agent Zero currently navigates with `Page.navigate` + `time.sleep(2)` — the same fragile timing pattern that Phase 6 fixed in startup.sh. This phase applies the same fix at the skill documentation level, ensuring the agent never treats navigation as complete before the page actually loads, and always observes state before acting.

Output: Updated `requirements.txt` with websocket-client, and a fully rewritten `usr/skills/shared-browser/SKILL.md` with navigate_and_wait(), verify_navigation(), and a first-class Observe-Act-Verify workflow section.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-browser-navigate-with-verification/07-RESEARCH.md
@.planning/phases/06-cdp-startup-health-check/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add websocket-client to requirements.txt</name>
  <files>requirements.txt</files>
  <action>
Open `requirements.txt` and append `websocket-client>=1.9.0` on a new line at the end of the file.

Use `>=1.9.0` (range, not pinned) to match the project convention established in STATE.md. The rest of requirements.txt uses a mix of `==` and `>=`; this new entry follows the `>=` convention.

Do NOT add any comment or section header — just the bare package spec on its own line.

After appending, verify the line exists: `grep "websocket-client" requirements.txt` must return exactly `websocket-client>=1.9.0`.
  </action>
  <verify>grep "websocket-client" /Users/rgv250cc/Documents/Projects/agent-zero/requirements.txt</verify>
  <done>requirements.txt contains the line `websocket-client>=1.9.0` with no duplicates</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite SKILL.md with navigate_and_wait, verify_navigation, and full Observe-Act-Verify</name>
  <files>usr/skills/shared-browser/SKILL.md</files>
  <action>
Rewrite `usr/skills/shared-browser/SKILL.md` in full. The new file must preserve all existing functional content (Method 3 xdotool, Decision Guide table, Troubleshooting table, DEFAULT BROWSER RULE, Stack table, Prerequisites) while making the following targeted improvements:

**Change 1: Update metadata**
- Bump version from `3.0` to `4.0`
- Update description to mention "navigate-with-verification" and "Observe-Act-Verify"

**Change 2: Add navigate_and_wait() to Method 2 CDP section**

Replace the bare "### Navigate" code block (currently just `send('Page.navigate', {'url': '...'})`) with a new "### Navigate with Verification (REQUIRED)" block that shows the full `navigate_and_wait()` function. Use the exact implementation from RESEARCH.md Pattern 1 + 4:

```python
import websocket, json, urllib.request, time, base64

def cdp_connect():
    """Connect to the first page tab in Chromium CDP."""
    tabs = json.loads(urllib.request.urlopen('http://localhost:9222/json').read())
    page_tabs = [t for t in tabs if t.get('type') == 'page']
    ws = websocket.create_connection(page_tabs[0]['webSocketDebuggerUrl'])
    return ws

msg_id = [0]
def send(ws, method, params={}):
    """Send CDP command, return response (skip async events)."""
    msg_id[0] += 1
    ws.send(json.dumps({'id': msg_id[0], 'method': method, 'params': params}))
    while True:
        resp = json.loads(ws.recv())
        if resp.get('id') == msg_id[0]:
            return resp
        # CDP events (no 'id') are skipped — correct for sync polling

def navigate_and_wait(ws, url, timeout=10):
    """
    Navigate to URL via CDP and wait until document.readyState == 'complete'.
    Returns True if page loaded within timeout, False if timed out.
    ALWAYS use this instead of bare Page.navigate + time.sleep().
    """
    send(ws, 'Page.navigate', {'url': url})
    time.sleep(0.1)   # Brief pause so navigation starts before polling readyState
    deadline = time.time() + timeout
    while time.time() < deadline:
        result = send(ws, 'Runtime.evaluate', {
            'expression': 'document.readyState',
            'returnByValue': True
        })
        state = result.get('result', {}).get('result', {}).get('value', '')
        if state == 'complete':
            return True
        time.sleep(0.5)
    return False  # Timed out — caller must screenshot and report state

def verify_navigation(ws, expected_url_contains=None):
    """Read current URL and title after navigation. Optionally assert URL match."""
    result = send(ws, 'Runtime.evaluate', {
        'expression': '({url: location.href, title: document.title})',
        'returnByValue': True
    })
    val = result.get('result', {}).get('result', {}).get('value', {})
    url = val.get('url', '')
    title = val.get('title', '')
    if expected_url_contains and expected_url_contains not in url:
        print(f"WARNING: Expected URL containing '{expected_url_contains}', got: {url}")
    return url, title

def take_screenshot(ws, path='/tmp/shared_browser.png'):
    """Take CDP screenshot and save to path. Use vision_load() to view."""
    result = send(ws, 'Page.captureScreenshot', {'format': 'png'})
    with open(path, 'wb') as f:
        f.write(base64.b64decode(result['result']['data']))
    return path
```

Note: Update the existing `send()` helper inline to use `send(ws, ...)` signature (ws as first arg), since `cdp_connect()` now returns `ws` as an explicit variable. The old setup section had `ws` as a module-level variable; the new version makes it explicit to support try/finally cleanup.

**Change 3: Add full navigate workflow example**

Add a "### Full Navigate Workflow (Observe-Act-Verify)" code block immediately after the helper functions:

```python
ws = cdp_connect()
try:
    # 1. OBSERVE — screenshot to see current state before acting
    take_screenshot(ws)
    # vision_load('/tmp/shared_browser.png')

    # 2. ACT — navigate with built-in readyState wait (NEVER bare Page.navigate + sleep)
    loaded = navigate_and_wait(ws, 'https://example.com')

    # 3. VERIFY — confirm the right page was reached
    if loaded:
        url, title = verify_navigation(ws, expected_url_contains='example.com')
        take_screenshot(ws)
        # vision_load('/tmp/shared_browser.png')
        print(f"Success: {title} — {url}")
    else:
        take_screenshot(ws)
        # vision_load('/tmp/shared_browser.png')
        print("WARNING: Page did not reach readyState=complete within 10s — see screenshot")
finally:
    ws.close()
```

**Change 4: Fix the "Capture LIVE Network + Console" section**

Replace the fragile `time.sleep(2)` on line 99 with a call to `navigate_and_wait(ws, url)`. The corrected block should be:

```python
send(ws, 'Network.enable')
send(ws, 'Log.enable')
navigate_and_wait(ws, 'https://example.com')   # replaces time.sleep(2)
# ... rest of drain loop unchanged ...
```

Note: `Network.enable` + `Log.enable` are set BEFORE calling `navigate_and_wait` — this is correct and must be preserved. The drain loop after (ws.settimeout(2) + while True recv) is for collecting events AFTER load, not for waiting for load — keep it intact.

**Change 5: Replace the 3-line "Workflow: Observe → Act → Verify" section**

Replace the current 3-bullet informal section with a full named section that makes screenshot-before-action a hard rule:

```markdown
## Workflow: Observe → Act → Verify

**RULE: ALWAYS take a screenshot and vision_load BEFORE every browser action.**
This is not optional. The screenshot is how the agent sees current state.

### Step-by-step

**1. OBSERVE**
```python
take_screenshot(ws)       # CDP screenshot
# vision_load('/tmp/shared_browser.png')   # Load into vision — see state
```
or via scrot (no CDP connection needed):
```bash
DISPLAY=:99 scrot /tmp/shared_browser.png -o
```

**2. ACT**
Choose the appropriate action:
- Navigate: `navigate_and_wait(ws, url)` — NEVER `Page.navigate` + `time.sleep()`
- Click by selector: `send(ws, 'Runtime.evaluate', {'expression': 'document.querySelector("selector").click()'})`
- Click by coordinates: `send(ws, 'Input.dispatchMouseEvent', ...)` or `xdotool mousemove X Y click 1`
- Type text: `xdotool type 'text'`
- Scroll: `xdotool key Page_Down`

**3. VERIFY**
After every action:
```python
take_screenshot(ws)
# vision_load('/tmp/shared_browser.png')
```
After navigation specifically, also verify URL and title:
```python
url, title = verify_navigation(ws, expected_url_contains='expected-domain.com')
print(f"{title} — {url}")
```

### Anti-Patterns (NEVER DO)
- `Page.navigate` + `time.sleep(N)`: fragile timing — use `navigate_and_wait()`
- Acting without observing: always screenshot first
- Assuming page state from a prior action: state may have changed
- Using `browser_agent` tool: spawns separate Playwright instance
```

**Change 6: Add Pitfalls section before Troubleshooting**

Add a "## Common Pitfalls" section with the 3 most critical pitfalls from RESEARCH.md:

1. `navigate_and_wait` returns True but screenshot shows blank/spinner — SPA pages render after readyState. Always screenshot and vision_load after navigate.
2. `navigate_and_wait` returns immediately (false positive from old page) — A `time.sleep(0.1)` after `Page.navigate` is included in the function for this reason. If you see immediate returns, verify it's actually navigating.
3. WebSocket left open between code blocks — use try/finally pattern. CDP allows multiple simultaneous connections but stale connections cause unexpected results.

Keep all existing content in the Troubleshooting table.

**Structure of the final file (in order):**
1. Metadata block (version 4.0)
2. Overview
3. DEFAULT BROWSER RULE
4. Stack table
5. Prerequisites
6. Method 1: Screenshot (Observe) — scrot, unchanged
7. Method 2: CDP WebSocket — updated with cdp_connect(), send(ws,...), navigate_and_wait(), verify_navigation(), take_screenshot(), Full Navigate Workflow example, then remaining CDP snippets (JS eval, console errors, LIVE network [fixed], network resources, click, selector click, new tab, CDP screenshot, try/finally close)
8. Method 3: xdotool — unchanged
9. Decision Guide table — unchanged
10. Workflow: Observe-Act-Verify — full expanded section (Change 5)
11. Common Pitfalls — new section (Change 6)
12. Troubleshooting table — unchanged
  </action>
  <verify>
1. `grep -c "navigate_and_wait" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must return >= 3 (definition + navigate workflow + LIVE network fix)
2. `grep -c "verify_navigation" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must return >= 2 (definition + workflow example)
3. `grep "time.sleep(2)" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must return empty (removed)
4. `grep "document.readyState" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must return >= 1 match
5. `grep "ALWAYS" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must return >= 1 (enforcement language)
6. `grep "version: 4.0" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must return 1 match
7. `wc -l /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` — must be >= 200 lines
  </verify>
  <done>
- SKILL.md version is 4.0
- navigate_and_wait() function is defined with readyState poll (no bare Page.navigate + sleep pattern)
- verify_navigation() function is defined and used in the full workflow example
- take_screenshot() is defined as a named helper
- The "Capture LIVE Network" section uses navigate_and_wait(), not time.sleep(2)
- "Observe-Act-Verify" is a full named section with numbered steps and enforcement language
- "Common Pitfalls" section documents SPA false-positive, stale readyState, and WS cleanup
- All existing content (xdotool, Decision Guide, Troubleshooting) is preserved
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `grep "websocket-client" /Users/rgv250cc/Documents/Projects/agent-zero/requirements.txt` returns `websocket-client>=1.9.0`
2. `grep -c "navigate_and_wait" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` returns >= 3
3. `grep "time.sleep(2)" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` returns empty (the fragile sleep is gone)
4. `grep "document.readyState" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` returns >= 1 line
5. `grep "verify_navigation" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` returns >= 2 lines
6. `grep "ALWAYS" /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` returns >= 1 line (enforcement language present)
7. `wc -l /Users/rgv250cc/Documents/Projects/agent-zero/usr/skills/shared-browser/SKILL.md` returns >= 200
</verification>

<success_criteria>
Phase 7 is complete when:
- requirements.txt contains `websocket-client>=1.9.0` (BROWSER-01 dependency unblocked)
- SKILL.md v4.0 documents `navigate_and_wait()` with `document.readyState` poll — bare Page.navigate + sleep pattern eliminated (BROWSER-01)
- SKILL.md mandates screenshot before every action with explicit enforcement language (BROWSER-02)
- SKILL.md documents `verify_navigation()` reads current URL and page title post-navigate (BROWSER-03)
- SKILL.md has a first-class named "Observe-Act-Verify" section with numbered steps and anti-pattern list (BROWSER-05)
- The fragile `time.sleep(2)` in the LIVE network section is replaced with `navigate_and_wait()` (BROWSER-01 scope complete)
</success_criteria>

<output>
After completion, create `.planning/phases/07-browser-navigate-with-verification/07-01-SUMMARY.md`
</output>
