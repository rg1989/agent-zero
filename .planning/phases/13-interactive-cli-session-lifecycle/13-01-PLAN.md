---
phase: 13-interactive-cli-session-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md
autonomous: true
requirements: [CLI-01, CLI-02, CLI-03, CLI-04]

must_haves:
  truths:
    - "OpenCode v1.2.5 (or later) Linux aarch64 binary is installed at /root/.opencode/bin/opencode inside the Docker container and responds to opencode --version"
    - "OpenCode is configured inside Docker to reach Ollama via host.docker.internal:11434 (not localhost)"
    - "The exact ANSI-stripped last-non-blank-line text at the OpenCode TUI ready-for-input state is documented and regex-testable"
    - "The exact text pattern that appears during AI processing (busy state) is documented, distinguishable from the ready state"
    - "The correct exit sequence (verified /exit vs Ctrl+C vs Ctrl+D) for OpenCode TUI is confirmed with observed shell-prompt-return evidence"
    - "Startup time from opencode command to first ready state is measured and documented (for timeout sizing)"
    - "13-01-OBSERVATION.md exists with all findings structured for Plan 13-02 consumption"
  artifacts:
    - path: ".planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md"
      provides: "Empirical OpenCode TUI prompt patterns, startup time, busy-state indicator, exit sequence"
      contains: "prompt_pattern"
  key_links:
    - from: "13-01-OBSERVATION.md"
      to: "13-02-PLAN.md"
      via: "prompt_pattern value consumed by Plan 13-02 implementation"
      pattern: "prompt_pattern"
---

<objective>
Empirically observe OpenCode TUI behavior inside the Docker container to establish the exact prompt patterns and lifecycle timings that Plan 13-02 will encode.

Purpose: All four CLI requirements (CLI-01..04) depend on correct prompt_pattern values for wait_ready. These values CANNOT be determined from documentation — the OpenCode TUI uses Bubble Tea / SolidJS rendering with box-drawing characters. The only valid source is direct observation of the actual installed binary in the actual runtime environment.

Output: 13-01-OBSERVATION.md with: verified version, exact ready-state prompt pattern (ANSI-stripped), busy-state indicator, startup time measurement, exit sequence confirmation, and a ready-to-use `prompt_pattern` regex string for Plan 13-02.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-interactive-cli-session-lifecycle/13-RESEARCH.md
@.planning/phases/12-readiness-detection/12-01-SUMMARY.md
@python/tools/tmux_tool.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install OpenCode in Docker and verify version</name>
  <files>.planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md</files>
  <action>
    Run the following commands from the host shell to install OpenCode inside the running Docker container and verify it works:

    ```bash
    # Install OpenCode binary (Linux aarch64 via official install script)
    docker exec agent-zero bash -c "curl -fsSL https://opencode.ai/install | bash"

    # Add to PATH permanently in .bashrc inside container
    docker exec agent-zero bash -c "echo 'export PATH=/root/.opencode/bin:\$PATH' >> /root/.bashrc"

    # Verify version — MUST be 1.2.5 or later
    docker exec agent-zero bash -c "export PATH=/root/.opencode/bin:\$PATH && opencode --version"
    ```

    If version < 1.2.5: STOP. Document the version in OBSERVATION.md under "## BLOCKER: Version Regression Risk" and flag that the hang regression (issue #3213) may apply. The plan should not proceed past Task 1 in this case — file the finding and the executor must pause for user decision.

    If version >= 1.2.5: continue to Task 2.

    Record version string in the `## Version` section of 13-01-OBSERVATION.md.
  </action>
  <verify>
    ```bash
    docker exec agent-zero bash -c "export PATH=/root/.opencode/bin:\$PATH && opencode --version"
    ```
    Output must contain a version string like `1.2.5` or later. No "command not found".
  </verify>
  <done>opencode binary responds to --version inside Docker with version >= 1.2.5; version recorded in OBSERVATION.md.</done>
</task>

<task type="auto">
  <name>Task 2: Configure OpenCode for Docker-to-host Ollama access</name>
  <files>.planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md</files>
  <action>
    Copy the host opencode config into Docker and update the baseURL to use host.docker.internal instead of localhost:

    ```bash
    # Create config directory inside container
    docker exec agent-zero mkdir -p /root/.config/opencode

    # Copy existing config from host (if ~/.config/opencode/ai.opencode.json exists)
    docker cp ~/.config/opencode/ai.opencode.json agent-zero:/root/.config/opencode/ai.opencode.json

    # Update localhost → host.docker.internal so Docker can reach host Ollama
    docker exec agent-zero sed -i 's|localhost:11434|host.docker.internal:11434|g' /root/.config/opencode/ai.opencode.json

    # Verify config contains host.docker.internal
    docker exec agent-zero cat /root/.config/opencode/ai.opencode.json
    ```

    If ~/.config/opencode/ai.opencode.json does NOT exist on the host, create it with the minimal Ollama config from RESEARCH.md Pattern 3 (qwen2.5-coder:latest model, baseURL=http://host.docker.internal:11434/v1), then copy into Docker.

    Also ensure Ollama is running on the host: `ollama serve &` (or confirm it is already running).

    Record in OBSERVATION.md under `## LLM Config`: the model used for testing, and confirmation of host.docker.internal reachability.

    Add `"permission": "allow"` to the config as a precaution against the subprocess permission-dialog hang (RESEARCH.md Pitfall 5, issue #11891). Add it at the top level of the JSON object:
    ```json
    {
      "permission": "allow",
      ...
    }
    ```
  </action>
  <verify>
    ```bash
    docker exec agent-zero grep "host.docker.internal" /root/.config/opencode/ai.opencode.json
    ```
    Must return at least one match containing `host.docker.internal:11434`.
  </verify>
  <done>OpenCode config inside Docker points to host.docker.internal:11434; "permission": "allow" set; Ollama accessible from container.</done>
</task>

<task type="auto">
  <name>Task 3: Run observation session and document TUI lifecycle patterns</name>
  <files>.planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md</files>
  <action>
    This task performs the core empirical observation. Execute the observation protocol from RESEARCH.md Pattern 2.

    **Step 1: Attach to the shared tmux session for observation**
    From the Docker container, start OpenCode in the shared tmux pane. All tmux commands run from inside Docker via docker exec:

    ```bash
    # Start OpenCode in the shared tmux pane (pane shared:0.0)
    docker exec agent-zero bash -c "tmux send-keys -t shared 'export PATH=/root/.opencode/bin:\$PATH && opencode /a0' Enter"
    ```

    **Step 2: Capture at t=0.5s, t=1s, t=2s, t=3s, t=5s during startup**
    ```bash
    for delay in 0.5 1 2 3 5; do
      sleep $delay
      echo "=== t=${delay}s ==="
      docker exec agent-zero bash -c "
        tmux capture-pane -t shared -p -S -50 |
        python3 -c \"
import sys, re
ANSI_RE = re.compile(r'\x1b(?:\][^\x07]*\x07|[@-Z\\\\\\\\-_]|\[[0-?]*[ -/]*[@-~])')
text = sys.stdin.read()
clean = ANSI_RE.sub('', text).rstrip()
lines = [l for l in clean.splitlines() if l.strip()]
print('LAST_NON_BLANK:', repr(lines[-1]) if lines else '(empty)')
print('---FULL---')
print(clean)
\""
    done
    ```

    **Step 3: When TUI shows ready state (logo rendered, input area active) — capture the ready state**
    Wait until the screen stabilizes (approximately 3-5s after start). Then:
    ```bash
    docker exec agent-zero bash -c "
      tmux capture-pane -t shared -p -S -50 |
      python3 -c \"
import sys, re
ANSI_RE = re.compile(r'\x1b(?:\][^\x07]*\x07|[@-Z\\\\\\\\-_]|\[[0-?]*[ -/]*[@-~])')
clean = ANSI_RE.sub('', sys.stdin.read()).rstrip()
lines = [l for l in clean.splitlines() if l.strip()]
print('=== READY STATE ===')
print('LAST_NON_BLANK:', repr(lines[-1]) if lines else '(empty)')
print('ALL_NON_BLANK_LINES:')
for i, l in enumerate(lines[-5:]):
    print(f'  [-{5-i}]:', repr(l))
\""
    ```

    **Step 4: Send a test prompt and capture busy state**
    ```bash
    docker exec agent-zero bash -c "tmux send-keys -t shared 'What is 2+2? Reply with just the number.' Enter"
    # Capture every 2s for 10s to observe busy state
    for i in 1 2 3 4 5; do
      sleep 2
      echo "=== busy t=${i}x2s ==="
      docker exec agent-zero bash -c "
        tmux capture-pane -t shared -p -S -50 |
        python3 -c \"
import sys, re
ANSI_RE = re.compile(r'\x1b(?:\][^\x07]*\x07|[@-Z\\\\\\\\-_]|\[[0-?]*[ -/]*[@-~])')
clean = ANSI_RE.sub('', sys.stdin.read()).rstrip()
lines = [l for l in clean.splitlines() if l.strip()]
print('LAST_NON_BLANK:', repr(lines[-1]) if lines else '(empty)')
\""
    done
    ```

    **Step 5: Capture response-complete state (ready again)**
    After the response appears stable, capture:
    ```bash
    docker exec agent-zero bash -c "
      tmux capture-pane -t shared -p -S -50 |
      python3 -c \"
import sys, re
ANSI_RE = re.compile(r'\x1b(?:\][^\x07]*\x07|[@-Z\\\\\\\\-_]|\[[0-?]*[ -/]*[@-~])')
clean = ANSI_RE.sub('', sys.stdin.read()).rstrip()
lines = [l for l in clean.splitlines() if l.strip()]
print('=== POST-RESPONSE STATE ===')
print('LAST_NON_BLANK:', repr(lines[-1]) if lines else '(empty)')
for i, l in enumerate(lines[-5:]):
    print(f'  [-{5-i}]:', repr(l))
\""
    ```

    **Step 6: Exit and verify shell prompt returns**
    ```bash
    docker exec agent-zero bash -c "tmux send-keys -t shared '/exit' Enter"
    sleep 3
    docker exec agent-zero bash -c "tmux capture-pane -t shared -p -S -20"
    ```

    **Document ALL findings in 13-01-OBSERVATION.md** using the template below:

    ```markdown
    # 13-01: OpenCode TUI Observation Log

    **Date:** 2026-02-25
    **OpenCode version:** [INSERT]
    **Docker arch:** aarch64 (Kali Linux)

    ## Version
    opencode --version output: [INSERT EXACT OUTPUT]

    ## LLM Config
    Model used: [INSERT]
    baseURL: http://host.docker.internal:11434/v1
    Ollama status during test: [running/not-running/error]

    ## Startup Sequence

    | Time | Last Non-Blank Line (repr) | Notes |
    |------|---------------------------|-------|
    | t=0.5s | [INSERT] | |
    | t=1s | [INSERT] | |
    | t=2s | [INSERT] | |
    | t=3s | [INSERT] | |
    | t=5s | [INSERT] | |

    Startup stabilizes at approximately: [N]s

    ## Ready State (idle, awaiting input)

    Last non-blank line (repr): [INSERT]
    Last 5 non-blank lines:
      [-5]: [INSERT repr]
      [-4]: [INSERT repr]
      [-3]: [INSERT repr]
      [-2]: [INSERT repr]
      [-1]: [INSERT repr]

    Proposed prompt_pattern regex: [INSERT]
    Pattern test: re.search(r'[PATTERN]', [LAST_LINE_REPR]) → [Match/None]

    ## Busy State (AI processing)

    Last non-blank line during processing: [INSERT repr]
    Does it match ready-state pattern? [YES — bad / NO — good]
    Distinguishing characteristic: [INSERT]

    ## Post-Response State (ready again)

    Last non-blank line (repr): [INSERT]
    Same as initial ready state? [YES/NO]
    Notes: [INSERT]

    ## Exit Sequence

    Command used: /exit (Enter)
    Shell prompt visible after exit? [YES/NO]
    Last non-blank line after exit (repr): [INSERT]
    Shell prompt matches default r'[$#>%]\s*$': [YES/NO]
    Time to shell return: [N]s

    ## Auth / Welcome Prompt on First Start

    Did opencode prompt for any auth or onboarding? [YES/NO]
    If yes, describe: [INSERT]

    ## Final Recommendations for Plan 13-02

    ### prompt_pattern for CLI-01/CLI-02/CLI-03 (OpenCode ready state):
    ```
    r'[INSERT FINAL PATTERN]'
    ```

    ### timeout values:
    - CLI-01 startup wait_ready timeout: [N]s (observed startup: [N]s, add 2x buffer)
    - CLI-02/03 response wait_ready timeout: 120s (default AI response budget)
    - CLI-04 exit wait_ready timeout: 15s (shell return observed in ~[N]s)

    ### Exit sequence for CLI-04:
    Primary: send "/exit" + Enter
    Fallback: keys "C-c" if /exit fails

    ### Blockers/Issues:
    [None / INSERT any unexpected findings]
    ```

    If any step shows an unexpected auth prompt, TUI error, or unrecognized behavior, document it verbatim and note "REQUIRES INVESTIGATION" — do NOT attempt to work around it autonomously; surface it in the OBSERVATION.md for user review.
  </action>
  <verify>
    1. `.planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md` exists and has content
    2. OBSERVATION.md contains a `## Ready State` section with a non-empty `prompt_pattern` entry
    3. OBSERVATION.md contains a `## Exit Sequence` section confirming shell prompt returns after `/exit`
    4. OBSERVATION.md contains a `## Final Recommendations for Plan 13-02` section with a concrete `prompt_pattern` value
    5. The pane content shows the shell prompt has returned after the observation session (container is clean)
  </verify>
  <done>
    13-01-OBSERVATION.md documents all lifecycle states with exact ANSI-stripped last-non-blank-line values.
    A prompt_pattern regex is confirmed testable (re.search matches the ready state, does NOT match busy state).
    Exit sequence is confirmed (shell prompt visible after /exit).
    Plan 13-02 has a concrete, verified prompt_pattern to implement.
  </done>
</task>

</tasks>

<verification>
1. `docker exec agent-zero bash -c "export PATH=/root/.opencode/bin:\$PATH && opencode --version"` returns version >= 1.2.5
2. `docker exec agent-zero cat /root/.config/opencode/ai.opencode.json` shows `host.docker.internal:11434` (not localhost)
3. `.planning/phases/13-interactive-cli-session-lifecycle/13-01-OBSERVATION.md` exists with all required sections
4. OBSERVATION.md `## Final Recommendations` section contains a concrete `prompt_pattern` string
5. OBSERVATION.md `## Exit Sequence` confirms `/exit` returns shell prompt
</verification>

<success_criteria>
- OpenCode binary installed and verified in Docker (version >= 1.2.5)
- Ollama config updated for Docker networking (host.docker.internal)
- TUI lifecycle fully observed: startup, idle-ready, busy, post-response, exit
- All observations documented with exact repr() of last-non-blank-line at each state
- `prompt_pattern` regex derived and validated against captured output
- Plan 13-02 has concrete, unambiguous inputs — no remaining "must observe" unknowns
</success_criteria>

<output>
After completion, create `.planning/phases/13-interactive-cli-session-lifecycle/13-01-SUMMARY.md`
</output>
