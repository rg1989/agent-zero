---
phase: 10-claude-cli-skill-documentation
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - usr/skills/claude-cli/SKILL.md
autonomous: true
requirements:
  - CLAUDE-05

must_haves:
  truths:
    - "usr/skills/claude-cli/SKILL.md exists with all required sections"
    - "An agent can copy-paste the single-turn inline block directly and it works — includes env_clean, subprocess.run, json.loads, no ellipsis, no missing imports"
    - "An agent can copy-paste the ClaudeSession multi-turn block directly and session memory is maintained across turns"
    - "The Decision Guide table tells the agent which function to call without reading any other file"
    - "--session-id / --resume UUID options are documented for multi-agent session coordination"
    - "Security notes cover all three required areas: API key handling, subprocess scope of env fix, NEVER globally unset"
  artifacts:
    - path: "usr/skills/claude-cli/SKILL.md"
      provides: "Complete runnable skill document for claude CLI invocation"
      min_lines: 150
      contains: "env_clean"
  key_links:
    - from: "usr/skills/claude-cli/SKILL.md"
      to: "python/helpers/claude_cli.py"
      via: "import statement and inline pattern fidelity"
      pattern: "claude_cli"
    - from: "usr/skills/claude-cli/SKILL.md"
      to: "claude --print --resume"
      via: "documented CLI flags"
      pattern: "--resume"
---

<objective>
Create `usr/skills/claude-cli/SKILL.md` — a self-contained, runnable skill document for all validated claude CLI invocation patterns.

Purpose: Any Agent Zero session can load this skill and invoke claude correctly without re-discovering the CLAUDECODE env fix, the single-turn/multi-turn patterns, or the dead-session recovery approach. All content was empirically verified in Phases 8 and 9.

Output: One new file — `usr/skills/claude-cli/SKILL.md` (~150-200 lines). No code changes. No new dependencies.
</objective>

<execution_context>
@/Users/rgv250cc/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rgv250cc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-claude-cli-skill-documentation/10-RESEARCH.md
@.planning/phases/09-claude-cli-multi-turn-sessions/09-01-SUMMARY.md
@python/helpers/claude_cli.py
@usr/skills/shared-browser/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usr/skills/claude-cli/SKILL.md</name>
  <files>usr/skills/claude-cli/SKILL.md</files>
  <action>
Create `usr/skills/claude-cli/` directory (mkdir -p) and write `SKILL.md`.

The skill document must follow the `usr/skills/shared-browser/SKILL.md` structural template: metadata header, overview + DEFAULT RULE, stack table, prerequisites + CRITICAL env fix, numbered patterns with complete copy-paste code blocks, decision guide, completion detection, ANSI stripping note, session coordination, security notes, anti-patterns, common pitfalls, and troubleshooting table. Target ~150-200 lines.

**Metadata header:**
```
name: claude-cli
version: 1.0
description: Call the claude CLI from Agent Zero Python runtime — single-turn queries and multi-turn conversations
tags: [claude, cli, subprocess, multi-turn, env-fix, session]
```

**Overview + DEFAULT RULE:**
Load this skill when any task requires calling claude CLI as a subprocess from Agent Zero's Python runtime. Scope: host-only — `claude` binary is installed on the host at `~/.local/bin/claude` (on PATH). NOT available inside Docker container.

**Stack table:** claude CLI 2.1.56, Python `code_execution_tool` runtime, stdlib only (subprocess, os, json, re), helper module `python/helpers/claude_cli.py` (importable from Agent Zero Python runtime).

**CRITICAL env fix section (most important — comes before all code examples):**
```
CRITICAL: Claude Code sets CLAUDECODE=1 in its environment. The claude binary
checks this variable and refuses to launch:
  "claude: error: Claude Code cannot be launched inside another Claude Code session."

Fix: Remove CLAUDECODE from the subprocess env — per-call ONLY, never globally:
  env_clean = {k: v for k, v in os.environ.items() if k != 'CLAUDECODE'}
  subprocess.run(cmd, env=env_clean, ...)

WARNING: NEVER del os.environ['CLAUDECODE'] — that mutates the whole process.
```

**Four numbered patterns — each must be a COMPLETE, RUNNABLE code block (no ellipsis, no "fill in the blank"):**

Pattern 1: Single-Turn via import:
```python
import sys
sys.path.insert(0, '/a0')
from python.helpers.claude_cli import claude_single_turn

response = claude_single_turn("What is the capital of France?")
print(response)  # "Paris"

# Plain text variant (no JSON metadata):
from python.helpers.claude_cli import claude_single_turn_text
text = claude_single_turn_text("Summarize in one sentence: Agent Zero is ...")
```

Pattern 1b: Single-Turn inline (no import — standalone copy-paste):
```python
import subprocess, os, json, re

ANSI_RE = re.compile(r"\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])")
env_clean = {k: v for k, v in os.environ.items() if k != 'CLAUDECODE'}

result = subprocess.run(
    ['claude', '--print', '--output-format', 'json', 'What is the capital of France?'],
    capture_output=True, text=True, env=env_clean, timeout=120
)
data = json.loads(ANSI_RE.sub('', result.stdout).strip())
print(data['result'])   # "Paris"
print(data['session_id'])  # UUID (single-turn still creates a session file)
```

Pattern 2: Multi-Turn via ClaudeSession (recommended — session_id managed automatically):
```python
import sys
sys.path.insert(0, '/a0')
from python.helpers.claude_cli import ClaudeSession

session = ClaudeSession()
r1 = session.turn("My name is Alice.")      # "Got it!"
r2 = session.turn("What is my name?")       # "Your name is Alice."
sid = session.session_id                     # UUID string (for coordination)

session.reset()                              # Start fresh — next turn = new session
r3 = session.turn("Hello!")                 # new session, no memory of Alice
```

Pattern 3: Multi-Turn via claude_turn() — manual session_id (for multi-agent coordination):
```python
from python.helpers.claude_cli import claude_turn

# Turn 1 — new session (session_id=None starts fresh)
resp1, sid = claude_turn("My secret number is 42. Reply: GOT_IT")
# resp1 = 'GOT_IT', sid = 'c56c44fa-...'

# Turn 2 — resume same conversation
resp2, sid = claude_turn("What is my secret number?", session_id=sid)
# resp2 = 'Your secret number is 42.'

# Turn 3 — continue; pass sid to next turn again
resp3, sid = claude_turn("Double it.", session_id=sid)
# resp3 = '84'
```

Pattern 4: Dead Session Recovery (robust multi-turn):
```python
from python.helpers.claude_cli import claude_turn_with_recovery

# sid may be stale from a previous run or expired session
resp, new_sid, was_recovered = claude_turn_with_recovery(
    "Continue our task.", session_id=sid
)
if was_recovered:
    print("WARNING: Session was lost. Claude has no memory of prior context.")
    # Re-establish context here before proceeding
```

Dead session error reference (what it looks like):
```
# Command: claude --print --output-format json --resume 00000000-... "Hello"
returncode: 1
stdout: ''
stderr: 'No conversation found with session ID: 00000000-...\n'
# Exits immediately (~1s) — no API call made
```

JSON response schema (what the helper functions parse):
```json
{
    "type": "result",
    "subtype": "success",
    "is_error": false,
    "duration_ms": 5100,
    "result": "Your secret number is 42.",
    "session_id": "c56c44fa-93ee-4be6-be63-c4c10f3886fe",
    "total_cost_usd": 0.0068,
    "usage": { "input_tokens": 25, "cache_read_input_tokens": 16207, "output_tokens": 12 }
}
```

**Decision Guide table:**

| Need | Use |
|---|---|
| One-shot AI query, no memory needed | `claude_single_turn(prompt)` |
| One-shot, plain text only | `claude_single_turn_text(prompt)` |
| Multi-turn conversation, session managed automatically | `ClaudeSession().turn(prompt)` |
| Multi-turn, need session_id to coordinate agents | `claude_turn(prompt, session_id=sid)` |
| Resume a known session from another context | `claude_turn(prompt, session_id='UUID-from-prior-run')` |
| Robust multi-turn with automatic dead-session recovery | `claude_turn_with_recovery(prompt, session_id=sid)` |

**Completion Detection section:**
`subprocess.run()` blocks until the process exits. `returncode == 0` = success. `returncode != 0` = failure. No idle-timeout, no prompt-pattern detection, no PTY needed. Dead sessions fail immediately (~1s, returncode 1).

**ANSI Stripping section:**
With `capture_output=True` (which all functions use), claude emits zero ANSI codes. The `ANSI_RE` strip in every function is a DEFENSIVE safety net only — a no-op in the normal path. Do NOT switch to PTY/TTY mode for programmatic use.

**Session Coordination section (required by CLAUDE-05):**
`--resume UUID` continues an existing session. `--session-id UUID` pre-allocates a UUID before the first turn (for multi-agent coordination — generate UUID with `import uuid; str(uuid.uuid4())`). Session files are stored at `~/.claude/projects/<cwd-encoded>/<session_id>.jsonl`. The `cwd` must be consistent across all turns of the same session — cwd change = dead session. Prompt caching is automatic: subsequent turns cache-read prior context, significantly reducing cost per turn.

**Security Notes section (required by CLAUDE-05 — cover all three):**
1. API key handling: `claude` reads `ANTHROPIC_API_KEY` from env or `~/.claude/` config. The `env_clean` dict comprehension passes `ANTHROPIC_API_KEY` through to the subprocess — correct behavior. Never hardcode API keys.
2. Subprocess scope of env fix: `env_clean = {k: v ...}` creates a NEW dict for that subprocess ONLY. The parent process `os.environ` is NOT modified. All other Agent Zero subprocesses continue to inherit the unmodified environment.
3. NEVER globally unset: `del os.environ['CLAUDECODE']`, `os.unsetenv('CLAUDECODE')`, and shell `unset CLAUDECODE` affect the parent process globally — they break CLAUDECODE=1 detection for any nested Claude Code session logic.

**Anti-Patterns (NEVER DO) section:**
- Interactive claude (no `--print`) for programmatic use — TUI rendering, no response boundary, unreliable
- `--continue` instead of `--resume UUID` when multiple sessions may be active (cwd race condition)
- `del os.environ['CLAUDECODE']` or `os.unsetenv()` — global env mutation; use per-call dict only
- Parsing output without `capture_output=True` — PTY mode leaks OSC sequences that survive ANSI_RE strip
- Manually injecting conversation history as context strings — use `--resume UUID` instead (native session preserves structured message history, avoids token inflation)

**Common Pitfalls table:**

| Pitfall | Fix |
|---|---|
| CLAUDECODE not removed | Build `env_clean` dict; pass as `env=env_clean` |
| `--continue` picks up wrong session | Use `--resume UUID` (explicit, no cwd race) |
| cwd changes between turns | Pass same `cwd=` to all subprocess.run calls for a session |
| `--no-session-persistence` + `--resume` | Session file not written → dead session immediately |
| Timeout too short | Increase timeout (default 120s); check API connectivity |

**Troubleshooting table:**

| Problem | Fix |
|---|---|
| `claude: error: Cannot be launched inside another Claude Code session` | Add env_clean dict; pass `env=env_clean` |
| `json.loads JSONDecodeError: Extra data` | Not using `capture_output=True` — switch to subprocess.run(capture_output=True) |
| `RuntimeError: No conversation found with session ID:` | Session dead/expired — use `claude_turn_with_recovery()` or restart with `session_id=None` |
| `FileNotFoundError` for claude | claude binary not on PATH — check `shutil.which('claude')` or verify `~/.local/bin` is on PATH |
| `TimeoutExpired` | Increase timeout; check API connectivity |
| Session memory lost between turns | session_id not passed — use ClaudeSession to manage automatically |
| `--resume` finds wrong session | cwd changed between turns — ensure consistent cwd= in all subprocess.run calls |
| Skill doesn't apply | This skill is HOST-ONLY. Claude binary is not installed in Docker container |

Commit after creating the file: `feat(10): create usr/skills/claude-cli/SKILL.md`
  </action>
  <verify>
1. Run: `ls /path/to/project/usr/skills/claude-cli/SKILL.md` — file exists
2. Run: `wc -l usr/skills/claude-cli/SKILL.md` — at least 150 lines
3. Check required section headings are present: grep for "CRITICAL", "Decision Guide", "Security Notes", "Anti-Pattern", "Troubleshooting", "--resume", "env_clean"
4. Check all four patterns have complete code blocks: grep for "claude_single_turn", "ClaudeSession", "claude_turn", "claude_turn_with_recovery"
5. Check the three CLAUDE-05 security items: grep for "ANTHROPIC_API_KEY", "subprocess scope" or equivalent, "NEVER" (global mutation warning)
  </verify>
  <done>
`usr/skills/claude-cli/SKILL.md` exists, is at least 150 lines, contains all four copy-paste code patterns (single-turn, ClaudeSession, claude_turn manual, claude_turn_with_recovery), the Decision Guide table, Session Coordination section with --session-id/--resume documentation, and Security Notes covering all three CLAUDE-05 required areas. The CRITICAL env fix block appears before any code examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate SKILL.md structure and register phase completion</name>
  <files></files>
  <action>
Verify the SKILL.md is structurally complete, then create the phase SUMMARY.

**Step 1: Structural verification**

Run these checks to confirm all CLAUDE-05 requirements are met:

```bash
# File exists and has substantial content
wc -l usr/skills/claude-cli/SKILL.md

# CRITICAL env fix present
grep -c "env_clean" usr/skills/claude-cli/SKILL.md

# --resume flag documented (CLAUDE-05 req 2: session coordination)
grep -c "\-\-resume" usr/skills/claude-cli/SKILL.md

# Security notes cover all 3 required areas (CLAUDE-05 req 3)
grep -c "ANTHROPIC_API_KEY" usr/skills/claude-cli/SKILL.md
grep -c "subprocess" usr/skills/claude-cli/SKILL.md
grep -ci "never" usr/skills/claude-cli/SKILL.md

# All four public exports documented
grep -c "claude_single_turn" usr/skills/claude-cli/SKILL.md
grep -c "ClaudeSession" usr/skills/claude-cli/SKILL.md
grep -c "claude_turn_with_recovery" usr/skills/claude-cli/SKILL.md
```

All counts must be >= 1. If any check fails, fix the SKILL.md before proceeding.

**Step 2: CLAUDE-05 requirement mapping verification**

Confirm the three explicit CLAUDE-05 sub-requirements are covered:
1. "single-turn pattern (env -u CLAUDECODE claude --print --output-format json), multi-turn --resume UUID pattern, ANSI stripping, and completion detection" — all present in Pattern 1, Pattern 2/3, ANSI Stripping section, Completion Detection section
2. "the --session-id / --resume UUID options for multi-agent session coordination" — present in Session Coordination section
3. "security notes covering API key handling and subprocess scope of the env var fix" — present in Security Notes section (all 3 bullet points)

**Step 3: Create SUMMARY.md**

Create `.planning/phases/10-claude-cli-skill-documentation/10-01-SUMMARY.md` with the standard summary format documenting: file created (usr/skills/claude-cli/SKILL.md), line count, all four patterns documented, CLAUDE-05 satisfied, any deviations from plan.

Then commit: `docs(10): complete phase 10 — claude-cli skill documentation`
  </action>
  <verify>
All grep counts return >= 1. SUMMARY.md created at `.planning/phases/10-claude-cli-skill-documentation/10-01-SUMMARY.md`.
  </verify>
  <done>
All CLAUDE-05 structural checks pass. SUMMARY.md committed. Phase 10 complete.
  </done>
</task>

</tasks>

<verification>
1. `usr/skills/claude-cli/SKILL.md` exists with at least 150 lines
2. All four public exports from `python/helpers/claude_cli.py` are documented with runnable copy-paste code blocks (claude_single_turn, claude_single_turn_text, ClaudeSession, claude_turn, claude_turn_with_recovery)
3. CLAUDE-05 requirement fully satisfied: (a) all validated invocation patterns documented, (b) --session-id/--resume UUID multi-agent coordination documented, (c) security notes cover API key handling + subprocess scope + NEVER globally unset
4. The CRITICAL env fix block appears prominently before any code examples
5. Skill is scope-correct: clearly states host-only, not Docker
6. No code files were modified — this phase is documentation only
</verification>

<success_criteria>
- `usr/skills/claude-cli/SKILL.md` exists and is self-contained — an agent can load it and immediately use claude CLI correctly with no other reference
- All four copy-paste patterns are complete and runnable (no ellipsis, no missing imports)
- Decision Guide table enables function selection without reading any other file
- CLAUDE-05 requirement marked complete in REQUIREMENTS.md (done as part of SUMMARY creation)
- v1.1 milestone complete: all 10 phases done
</success_criteria>

<output>
After completion, create `.planning/phases/10-claude-cli-skill-documentation/10-01-SUMMARY.md`

Then update REQUIREMENTS.md to mark CLAUDE-05 as [x] complete.
Then update ROADMAP.md Phase 10 status to complete.
Then update STATE.md: Phase 10 complete, v1.1 milestone complete.
</output>