---
milestone: v1.2
audited: 2026-02-25T18:56:56Z
status: tech_debt
scores:
  requirements: 11/11
  phases: 5/5
  integration: 9/11
  flows: 2/2
gaps:
  requirements: []
  integration:
    - "CLI-01: prompts/agent.system.tool.tmux.md CLI-01 send text omits PATH export — should use 'export PATH=/root/.opencode/bin:$PATH && opencode /a0' to match SKILL.md and opencode_cli.py"
    - "CLI-01: prompts/agent.system.tool.tmux.md CLI-01 section has no 0.5s pre-wait_ready delay warning — agents reading only the prompt doc may hit stale-prompt false positive"
  flows: []
tech_debt:
  - phase: 11-tmux-primitive-infrastructure
    items:
      - "ANSI_RE and OPENCODE_PROMPT_PATTERN exist as copies in both tmux_tool.py and opencode_cli.py with no automated sync check — future edits to tmux_tool.py constants must be manually mirrored in opencode_cli.py"
      - "_TMUX_SESSION = 'shared' hardcoded independently in tmux_tool.py and opencode_cli.py — no shared constant; fragile if session name changes or CLI-EXT-03 (parallel sessions) is implemented"
  - phase: 14-opencode-session-wrapper
    items:
      - "send() returns full 300-line pane content including TUI chrome — no differential extraction; callers must parse or accept full content"
      - "exit() does not capture the session ID printed by OpenCode at exit ('Resume session: opencode -s ses_[ID]') — multi-session resumption not available to skill code"
      - "No documented recovery pattern when _wait_ready raises RuntimeError on timeout"
  - phase: 15-cli-orchestration-skill-documentation
    items:
      - "SKILL.md uses '## Metadata' heading format instead of YAML '---' frontmatter — skills_tool:load cli-orchestration returns 'not found' (same pre-existing pattern as claude-cli and shared-browser skills; file accessible via direct path read)"
      - "usr/skills/ has no live-reload bind mount in docker-compose.yml — SKILL.md changes require docker compose up --build to take effect in running container"
---

# Milestone v1.2 Audit — Terminal Orchestration

**Audited:** 2026-02-25T18:56:56Z
**Status:** TECH DEBT (no critical blockers — all 11 requirements satisfied)
**Score:** 11/11 requirements satisfied | 5/5 phases passed | 2/2 E2E flows complete

---

## Milestone Goal

> Agent Zero can interact with the shared terminal and interactive CLIs as a human would — type, read screen, send special keys, detect readiness — enabling orchestration of any CLI agent (starting with OpenCode).

---

## Phase Status

| Phase | Name | Status | VERIFICATION.md |
|-------|------|--------|-----------------|
| 11 | tmux Primitive Infrastructure | **Complete** | PASSED (6/6 truths) |
| 12 | Readiness Detection | **Complete** | PASSED (5/5 truths) |
| 13 | Interactive CLI Session Lifecycle | **Complete** | PASSED (4/4 truths) |
| 14 | OpenCode Session Wrapper | **Complete** | PASSED (6/6 truths) |
| 15 | CLI Orchestration Skill Documentation | **Complete** | PASSED (6/6 truths) |

**All 5 phases complete. No unverified phases.**

---

## Requirements Coverage

### 3-Source Cross-Reference

| REQ-ID | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final Status |
|--------|----------------|---------------------|-----------------|--------------|
| TERM-01 | passed (Phase 11) | listed (11-01, 11-02) | `[x]` | **satisfied** |
| TERM-02 | passed (Phase 11) | listed (11-01, 11-02) | `[x]` | **satisfied** |
| TERM-03 | passed (Phase 11) | listed (11-01, 11-02) | `[x]` | **satisfied** |
| TERM-04 | passed (Phase 11) | listed (11-01, 11-02) | `[x]` | **satisfied** |
| TERM-05 | passed (Phase 12) | listed (12-01) | `[x]` | **satisfied** |
| CLI-01 | passed (Phase 13) | listed (13-01, 13-02) | `[x]` | **satisfied** |
| CLI-02 | passed (Phase 13) | listed (13-01, 13-02) | `[x]` | **satisfied** |
| CLI-03 | passed (Phase 13) | listed (13-01, 13-02) | `[x]` | **satisfied** |
| CLI-04 | passed (Phase 13) | listed (13-01, 13-02) | `[x]` | **satisfied** |
| CLI-05 | passed (Phase 14) | listed (14-01) | `[x]` | **satisfied** |
| CLI-06 | passed (Phase 15) | listed (15-01) | `[x]` | **satisfied** |

> **Note on SUMMARY frontmatter:** Phase SUMMARY.md files use `requires`/`provides` dependency graph format rather than `requirements-completed` YAML field. Requirements coverage is drawn from VERIFICATION.md tables (primary source) and REQUIREMENTS.md traceability table. All three source signals align.

**Orphaned requirements:** None. All 11 REQ-IDs assigned to phases 11–15 are verified in VERIFICATION.md files.

**Score: 11/11 satisfied** — FAIL gate not triggered.

---

## Integration Check Results

### Cross-Phase Wiring

| From | To | Via | Status | Req |
|------|----|-----|--------|-----|
| Phase 11: `TmuxTool` (send/keys/read) | Agent dispatcher | `python/tools/` auto-discovery glob | WIRED | TERM-01..04 |
| Phase 11: `prompts/agent.system.tool.tmux.md` | Agent system prompt | `agent.system.tool.*.md` glob | WIRED | TERM-01..04 |
| Phase 11: `docker-compose.yml` bind mounts | Container (`/a0/python`, `/a0/prompts`) | `./python:/a0/python`, `./prompts:/a0/prompts` | WIRED | all |
| Phase 12: `_wait_ready()` | `TmuxTool` dispatch dict | `"wait_ready": self._wait_ready` at line 44 | WIRED | TERM-05 |
| Phase 12: `ANSI_RE` | `_wait_ready()` prompt matching | same module-level constant, no copy | WIRED | TERM-05 |
| Phase 13: `OPENCODE_PROMPT_PATTERN` | `opencode_cli.py` | byte-for-byte copy with source comment | WIRED | CLI-01..04 |
| Phase 13: `OPENCODE_START_TIMEOUT` | `opencode_cli.py` | byte-for-byte copy with source comment | WIRED | CLI-01 |
| Phase 13: `agent.system.tool.tmux.md` CLI-01..04 | Agent task knowledge | `## OpenCode Lifecycle Pattern` section | PARTIAL | CLI-01..04 |
| Phase 14: `OpenCodeSession.start()/.send()/.exit()` | Skill code callers | `from python.helpers.opencode_cli import OpenCodeSession` | WIRED | CLI-05 |
| Phase 14: `opencode_cli.py` | Container | `./python:/a0/python` bind mount | WIRED | CLI-05 |
| Phase 15: `usr/skills/cli-orchestration/SKILL.md` | Agent skill loading | `skills_tool:load cli-orchestration` | PARTIAL | CLI-06 |

**Partial connections (non-blocking tech debt):**

| Issue | Severity | Affects |
|-------|----------|---------|
| Prompt doc CLI-01 lacks PATH export and 0.5s pre-wait_ready delay warning | Low | CLI-01 (raw tmux_tool usage; OpenCodeSession unaffected) |
| SKILL.md uses `## Metadata` heading instead of YAML `---` frontmatter — `skills_tool:load` silently returns "not found" | Medium | CLI-06 (file readable via direct path; same pattern as claude-cli, shared-browser skills) |

### E2E Flow Analysis

#### ✓ Flow 1: Primitive terminal interaction (COMPLETE)
`tmux_tool send` → command executes in shared pane → `tmux_tool wait_ready` → `tmux_tool read` returns ANSI-stripped content.

All four primitives verified live in container (Phase 11 UAT). Readiness detection verified (Phase 12).

#### ✓ Flow 2: Full OpenCode CLI orchestration (COMPLETE)

| Step | Mechanism | Status |
|------|-----------|--------|
| Start shared terminal | `open_app` → `startup.sh` creates `shared` tmux session | WORKS |
| `OpenCodeSession.start()` | Sends `export PATH=... && opencode /a0` via tmux send-keys, then `_wait_ready(timeout=15, OPENCODE_PROMPT_PATTERN)` | WORKS |
| `OpenCodeSession.send(prompt)` | Sends prompt + Enter, then `_wait_ready(timeout=120, OPENCODE_PROMPT_PATTERN)` (negative-lookahead excludes busy `esc interrupt` state) | WORKS |
| `send()` returns pane content | `capture-pane -S -300`, ANSI-stripped, 300 lines | WORKS |
| `OpenCodeSession.exit()` | Ctrl+P palette → `exit` + Enter (avoids `/exit` agent-picker trap) → `_wait_ready(timeout=15, r'[$#>%]\s*$')` | WORKS |
| Multi-turn validated | "What is 2+2?" → "4"; "Add 1" → "5" confirmed in live container | WORKS |

---

## Tech Debt

### Phase 11

| Item | Severity | Notes |
|------|----------|-------|
| ANSI_RE not in shared module — exists as copies in `tmux_tool.py` and `opencode_cli.py` | Low | Values currently in sync; source comment in `opencode_cli.py` lines 29-31 prevents confusion |
| `_TMUX_SESSION = "shared"` hardcoded in two files | Low | Future risk if CLI-EXT-03 (parallel sessions) is implemented |

### Phase 14

| Item | Severity | Notes |
|------|----------|-------|
| `send()` returns full pane content (300 lines TUI chrome + response) — no differential extraction | Low | Callers must parse or accept full content |
| `exit()` does not capture session ID from OpenCode's exit output | Low | Multi-session resumption not available to skill code |
| No documented recovery pattern when `_wait_ready` raises `RuntimeError` on timeout | Low | Callers must handle exception themselves |

### Phase 15

| Item | Severity | Notes |
|------|----------|-------|
| `usr/skills/cli-orchestration/SKILL.md` has `## Metadata` heading format — `skills_tool:load` returns "not found" | Medium | Pre-existing pattern in fork (claude-cli, shared-browser); file readable via direct path; fix: add `---` YAML frontmatter |
| `usr/skills/` not bind-mounted — SKILL.md changes need `docker compose up --build` | Informational | Fix: add `./usr:/a0/usr` to `docker-compose.yml` |

**Total: 7 tech-debt items across 3 phases — all non-blocking.**

---

## Summary

All 5 phases of v1.2 Terminal Orchestration delivered the complete implementation stack:

- **Phase 11** — tmux primitives (send/keys/read, ANSI stripping, Docker bind mounts for live-reload)
- **Phase 12** — readiness detection (`wait_ready` dual-strategy: prompt-pattern + idle-timeout)
- **Phase 13** — empirical OpenCode lifecycle observation (prompt patterns, exit sequences, CLI-01..04)
- **Phase 14** — `OpenCodeSession` wrapper class with clean `.start()/.send()/.exit()` interface
- **Phase 15** — `usr/skills/cli-orchestration/SKILL.md` documenting all proven CLI orchestration patterns

All 11 requirements (TERM-01..05, CLI-01..06) are satisfied with implementation evidence. Cross-phase dependency chain is intact. The E2E orchestration flow (start → prompt → response → exit) is proven in a live Docker container with real OpenCode v1.2.14.

No critical blockers. 7 tech-debt items identified — all low-to-medium severity, all non-blocking. Milestone is ready to complete.

---

*Audited: 2026-02-25T18:56:56Z*
*Auditor: Claude (gsd-audit-milestone orchestrator + gsd-integration-checker)*
