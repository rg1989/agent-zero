<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Zero Monitor</title>
<style>
  :root {
    --bg: #0a0e1a;
    --panel: #0f1628;
    --panel2: #141c30;
    --border: #1e2d4a;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --accent3: #10b981;
    --accent4: #f59e0b;
    --danger: #ef4444;
    --text: #e2e8f0;
    --muted: #64748b;
    --glow: 0 0 20px rgba(0,212,255,0.15);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; min-height: 100vh; }
  
  /* Header */
  .header {
    background: var(--panel);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--glow);
    position: sticky; top: 0; z-index: 100;
  }
  .header-logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon { font-size: 28px; }
  .logo-text { font-size: 20px; font-weight: 700; letter-spacing: 1px; }
  .logo-text span { color: var(--accent); }
  .header-stats { display: flex; gap: 24px; align-items: center; }
  .stat-pill {
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 12px;
    display: flex; align-items: center; gap: 6px;
  }
  .stat-pill .dot { width: 8px; height: 8px; border-radius: 50%; }
  .dot-green { background: var(--accent3); box-shadow: 0 0 6px var(--accent3); animation: pulse 2s infinite; }
  .dot-blue { background: var(--accent); }
  .dot-purple { background: var(--accent2); }
  .refresh-btn {
    background: var(--panel2);
    border: 1px solid var(--accent);
    color: var(--accent);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s;
  }
  .refresh-btn:hover { background: var(--accent); color: var(--bg); }
  .last-update { font-size: 11px; color: var(--muted); }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  @keyframes shimmer { 0%{background-position:-200px 0} 100%{background-position:200px 0} }

  /* Layout */
  .main { padding: 24px; display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: auto auto; gap: 20px; max-width: 1800px; margin: 0 auto; }
  
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    box-shadow: var(--glow);
    animation: fadeIn 0.4s ease;
  }
  .panel-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .panel-title .icon { font-size: 16px; }

  /* Contexts panel - full width */
  .contexts-panel { grid-column: 1 / -1; }

  /* Context cards */
  .contexts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 14px; }
  .context-card {
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: border-color 0.2s;
    position: relative;
    overflow: hidden;
  }
  .context-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
    opacity: 0;
    transition: opacity 0.3s;
  }
  .context-card.active::before { opacity: 1; }
  .context-card.active { border-color: rgba(0,212,255,0.3); }
  .context-card:hover { border-color: rgba(0,212,255,0.5); }
  
  .ctx-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
  .ctx-name { font-size: 14px; font-weight: 600; color: var(--text); flex: 1; min-width: 0; }
  .ctx-name-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .ctx-id { font-size: 10px; color: var(--muted); font-family: monospace; margin-top: 2px; }
  .ctx-badge {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 600;
    flex-shrink: 0;
    margin-left: 8px;
  }
  .badge-active { background: rgba(16,185,129,0.2); color: var(--accent3); border: 1px solid rgba(16,185,129,0.4); }
  .badge-idle { background: rgba(100,116,139,0.2); color: var(--muted); border: 1px solid rgba(100,116,139,0.3); }
  .badge-scheduled { background: rgba(124,58,237,0.2); color: #a78bfa; border: 1px solid rgba(124,58,237,0.4); }

  .ctx-meta { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
  .ctx-meta-item { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
  .ctx-meta-item span { color: var(--text); font-weight: 600; }

  /* Agent hierarchy */
  .agents-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
  .agent-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    border-left: 3px solid;
    font-size: 12px;
  }
  .agent-row-0 { border-color: var(--accent); }
  .agent-row-1 { border-color: var(--accent2); margin-left: 12px; }
  .agent-row-2 { border-color: var(--accent4); margin-left: 24px; }
  .agent-row-3 { border-color: var(--danger); margin-left: 36px; }
  .agent-num { font-weight: 700; font-size: 11px; color: var(--accent); min-width: 24px; }
  .agent-iter { color: var(--muted); font-size: 10px; }
  .agent-tools { margin-left: auto; display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; max-width: 180px; }
  .tool-chip {
    font-size: 9px;
    padding: 2px 6px;
    background: rgba(0,212,255,0.1);
    border: 1px solid rgba(0,212,255,0.2);
    border-radius: 8px;
    color: var(--accent);
    white-space: nowrap;
  }

  /* Top tools used in context */
  .ctx-tools { display: flex; flex-wrap: wrap; gap: 6px; }
  .tool-pill {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .tool-pill-code { background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.25); color: var(--accent); }
  .tool-pill-call { background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.35); color: #a78bfa; }
  .tool-pill-skill { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.25); color: var(--accent3); }
  .tool-pill-resp { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.25); color: var(--accent4); }
  .tool-pill-other { background: rgba(100,116,139,0.15); border: 1px solid rgba(100,116,139,0.3); color: var(--muted); }
  .pill-count { font-weight: 700; }

  /* Tool frequency chart */
  .chart-panel { grid-column: span 2; }
  .bar-chart { display: flex; flex-direction: column; gap: 10px; }
  .bar-row { display: flex; align-items: center; gap: 10px; }
  .bar-label { font-size: 11px; color: var(--text); min-width: 160px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bar-track { flex: 1; height: 22px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; position: relative; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; display: flex; align-items: center; padding-left: 8px; font-size: 11px; font-weight: 600; }
  .bar-count { font-size: 11px; color: var(--muted); min-width: 30px; text-align: left; }

  /* Timeline */
  .timeline { display: flex; flex-direction: column; gap: 0; max-height: 500px; overflow-y: auto; }
  .timeline::-webkit-scrollbar { width: 4px; }
  .timeline::-webkit-scrollbar-track { background: transparent; }
  .timeline::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  
  .timeline-item {
    display: flex;
    gap: 12px;
    padding: 9px 0;
    border-bottom: 1px solid rgba(30,45,74,0.5);
    animation: fadeIn 0.3s ease;
  }
  .timeline-item:last-child { border-bottom: none; }
  .tl-time { font-size: 10px; color: var(--muted); min-width: 58px; padding-top: 2px; font-family: monospace; }
  .tl-icon { font-size: 14px; min-width: 20px; text-align: center; }
  .tl-body { flex: 1; min-width: 0; }
  .tl-heading { font-size: 12px; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .tl-meta { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .tl-tool { font-size: 10px; background: rgba(0,212,255,0.1); color: var(--accent); padding: 1px 6px; border-radius: 6px; display: inline-block; margin-top: 2px; }

  /* Empty state */
  .empty { text-align: center; padding: 40px; color: var(--muted); }
  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 14px; }

  /* Loading shimmer */
  .shimmer {
    background: linear-gradient(90deg, var(--panel2) 25%, var(--panel) 50%, var(--panel2) 75%);
    background-size: 400px 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 6px;
    height: 20px;
    margin-bottom: 8px;
  }

  @media (max-width: 900px) {
    .main { grid-template-columns: 1fr; }
    .chart-panel { grid-column: span 1; }
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-logo">
    <span class="logo-icon">ü§ñ</span>
    <div>
      <div class="logo-text">Agent<span>Zero</span> Monitor</div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px;">Real-time agent activity dashboard</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="stat-pill"><span class="dot dot-green"></span><span id="stat-active">0</span> Active</div>
    <div class="stat-pill"><span class="dot dot-blue"></span><span id="stat-contexts">0</span> Contexts</div>
    <div class="stat-pill"><span class="dot dot-purple"></span><span id="stat-tools">0</span> Tool Calls</div>
    <div class="last-update">Updated: <span id="last-update">‚Äî</span></div>
    <button class="refresh-btn" onclick="fetchState()">‚ü≥ Refresh</button>
  </div>
</div>

<div class="main">
  <!-- Contexts -->
  <div class="panel contexts-panel">
    <div class="panel-title"><span class="icon">üí¨</span> Active Contexts &amp; Agent Hierarchy</div>
    <div id="contexts-grid" class="contexts-grid">
      <div class="shimmer" style="height:120px"></div>
      <div class="shimmer" style="height:120px"></div>
    </div>
  </div>

  <!-- Tool frequency chart -->
  <div class="panel chart-panel">
    <div class="panel-title"><span class="icon">üîß</span> Tool Usage Frequency (All Time)</div>
    <div id="tool-chart" class="bar-chart"></div>
  </div>

  <!-- Live feed -->
  <div class="panel">
    <div class="panel-title"><span class="icon">‚ö°</span> Live Activity Feed</div>
    <div id="timeline" class="timeline"></div>
  </div>
</div>

<script>
const TOOL_COLORS = {
  code_execution_tool: ['#00d4ff','rgba(0,212,255,0.25)'],
  call_subordinate:    ['#a78bfa','rgba(124,58,237,0.25)'],
  skills_tool:         ['#10b981','rgba(16,185,129,0.25)'],
  response:            ['#f59e0b','rgba(245,158,11,0.25)'],
  browser_agent:       ['#f472b6','rgba(244,114,182,0.25)'],
  search_engine:       ['#38bdf8','rgba(56,189,248,0.25)'],
  memory_save:         ['#818cf8','rgba(129,140,248,0.25)'],
  memory_load:         ['#6ee7b7','rgba(110,231,183,0.25)'],
};

const TOOL_ICONS = {
  code_execution_tool: 'üíª',
  call_subordinate: 'ü§ñ',
  'skills_tool:load': 'üìö',
  'skills_tool:list': 'üìã',
  skills_tool: 'üìö',
  response: 'üí¨',
  browser_agent: 'üåê',
  search_engine: 'üîç',
  memory_save: 'üíæ',
  memory_load: 'üß†',
  memory_delete: 'üóëÔ∏è',
  memory_forget: 'üßπ',
  document_query: 'üìÑ',
  vision_load: 'üëÅÔ∏è',
  wait: '‚è≥',
  notify_user: 'üîî',
  behaviour_adjustment: '‚öôÔ∏è',
  default: 'üîß',
};

const TYPE_ICONS = { agent: 'ü§ñ', user: 'üë§', util: '‚öôÔ∏è' };

function toolClass(name) {
  if (!name) return '';
  if (name.startsWith('code')) return 'tool-pill-code';
  if (name.startsWith('call_sub')) return 'tool-pill-call';
  if (name.startsWith('skill')) return 'tool-pill-skill';
  if (name === 'response') return 'tool-pill-resp';
  return 'tool-pill-other';
}

function toolIcon(name) {
  return TOOL_ICONS[name] || TOOL_ICONS.default;
}

function timeSince(isoStr) {
  if (!isoStr) return '‚Äî';
  const d = new Date(isoStr);
  const secs = Math.floor((Date.now() - d) / 1000);
  if (secs < 60) return `${secs}s ago`;
  if (secs < 3600) return `${Math.floor(secs/60)}m ago`;
  if (secs < 86400) return `${Math.floor(secs/3600)}h ago`;
  return d.toLocaleDateString();
}

function renderContexts(contexts) {
  const grid = document.getElementById('contexts-grid');
  if (!contexts.length) {
    grid.innerHTML = '<div class="empty"><div class="empty-icon">üí≠</div><div class="empty-text">No contexts found</div></div>';
    return;
  }

  grid.innerHTML = contexts.map(ctx => {
    const isActive = ctx.is_active;
    const badgeClass = ctx.type === 'scheduled' ? 'badge-scheduled' : (isActive ? 'badge-active' : 'badge-idle');
    const badgeText = ctx.type === 'scheduled' ? '‚è∞ Scheduled' : (isActive ? 'üü¢ Active' : '‚è∏ Idle');

    const topTools = Object.entries(ctx.tool_counts)
      .sort((a,b) => b[1]-a[1])
      .slice(0,5)
      .map(([name, count]) => `
        <span class="tool-pill ${toolClass(name)}">
          ${toolIcon(name)} ${name.replace('_tool','').replace('call_subordinate','subordinate')}
          <span class="pill-count">${count}</span>
        </span>
      `).join('');

    const agents = ctx.agents.map(ag => {
      const recentTools = [...new Set(ag.tools_used.slice(-5))].slice(0,4);
      const level = Math.min(ag.number, 3);
      return `
        <div class="agent-row agent-row-${level}">
          <span class="agent-num">A${ag.number}</span>
          <span style="font-size:12px;color:#94a3b8">${ag.number === 0 ? 'üëë Main' : 'üîÄ Sub-' + ag.number}</span>
          <span class="agent-iter">${ag.iteration} iters</span>
          <div class="agent-tools">
            ${recentTools.map(t => `<span class="tool-chip">${toolIcon(t)} ${t.replace('_tool','').slice(0,12)}</span>`).join('')}
          </div>
        </div>
      `;
    }).join('');

    return `
      <div class="context-card ${isActive ? 'active' : ''}">
        <div class="ctx-header">
          <div class="ctx-name">
            <div class="ctx-name-text" title="${ctx.name}">${ctx.name}</div>
            <div class="ctx-id">#${ctx.id}</div>
          </div>
          <span class="ctx-badge ${badgeClass}">${badgeText}</span>
        </div>
        <div class="ctx-meta">
          <div class="ctx-meta-item">üë• Agents: <span>${ctx.agent_count}</span></div>
          <div class="ctx-meta-item">üìä Events: <span>${ctx.event_count}</span></div>
          <div class="ctx-meta-item">üïê <span>${timeSince(ctx.last_message)}</span></div>
        </div>
        ${agents ? `<div class="agents-list">${agents}</div>` : ''}
        ${topTools ? `<div class="ctx-tools">${topTools}</div>` : ''}
      </div>
    `;
  }).join('');
}

function renderToolChart(toolCounts) {
  const chart = document.getElementById('tool-chart');
  const entries = Object.entries(toolCounts).sort((a,b) => b[1]-a[1]).slice(0,12);
  if (!entries.length) { chart.innerHTML = '<div class="empty"><div class="empty-icon">üìä</div><div class="empty-text">No tool data yet</div></div>'; return; }
  
  const max = entries[0][1];
  chart.innerHTML = entries.map(([name, count], i) => {
    const pct = Math.max(4, (count / max) * 100);
    const colors = TOOL_COLORS[name] || ['#64748b', 'rgba(100,116,139,0.25)'];
    const hue = (i * 31) % 360;
    const color = colors[0];
    const bg = colors[1] || `hsla(${hue},70%,60%,0.2)`;
    return `
      <div class="bar-row">
        <div class="bar-label" title="${name}">${toolIcon(name)} ${name}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:${bg};color:${color}">${count}</div>
        </div>
        <div class="bar-count">${count}</div>
      </div>
    `;
  }).join('');
}

function renderTimeline(events) {
  const tl = document.getElementById('timeline');
  if (!events.length) { tl.innerHTML = '<div class="empty"><div class="empty-icon">‚ö°</div><div class="empty-text">No activity yet</div></div>'; return; }
  
  tl.innerHTML = events.slice(0,40).map(ev => {
    const icon = ev.tool ? toolIcon(ev.tool) : (TYPE_ICONS[ev.type] || 'üìå');
    const heading = ev.heading || ev.type;
    return `
      <div class="timeline-item">
        <div class="tl-time">${ev.time}</div>
        <div class="tl-icon">${icon}</div>
        <div class="tl-body">
          <div class="tl-heading">${heading}</div>
          <div class="tl-meta">${ev.chat_name} ¬∑ A${ev.agentno}</div>
          ${ev.tool ? `<div class="tl-tool">${ev.tool}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function updateStats(data) {
  const active = data.contexts.filter(c => c.is_active).length;
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-contexts').textContent = data.contexts.length;
  const totalTools = Object.values(data.global_tool_counts).reduce((a,b)=>a+b, 0);
  document.getElementById('stat-tools').textContent = totalTools;
  document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

async function fetchState() {
  try {
    const base = window.location.pathname.includes('agent-monitor') ? '/agent-monitor' : '';
    const res = await fetch(base + '/api/state');
    const data = await res.json();
    if (data.error) { console.error(data.error); return; }
    
    updateStats(data);
    renderContexts(data.contexts);
    renderToolChart(data.global_tool_counts);
    renderTimeline(data.global_timeline);
  } catch(e) {
    console.error('Failed to fetch state:', e);
  }
}

// Initial fetch + auto-refresh every 5 seconds
fetchState();
setInterval(fetchState, 5000);
</script>
</body>
</html>
